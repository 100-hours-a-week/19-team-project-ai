name: Re-Fit AI CD (V2 - Docker)

on:
  workflow_dispatch:
    inputs:
      sha:
        description: 'Commit SHA (ÎπàÏπ∏Ïù¥Î©¥ main Î∏åÎûúÏπò HEAD ÏÇ¨Ïö©)'
        required: false
        type: string
      image_tag:
        description: 'Docker image tag (e.g., main-abc1234, main-latest). use_existing_image=trueÏù¥Í≥† ÎπàÏπ∏Ïù¥Î©¥ main-latest ÏÇ¨Ïö©'
        required: false
        type: string
      use_existing_image:
        description: 'true: CIÏóêÏÑú Ïù¥ÎØ∏ Ìë∏ÏãúÎêú Ïù¥ÎØ∏ÏßÄ ÏÇ¨Ïö©, false: Ïù¥ ÏõåÌÅ¨ÌîåÎ°úÏö∞ÏóêÏÑú ÎπåÎìú'
        required: true
        type: boolean
        default: false

permissions:
  contents: read
  actions: read

env:
  PYTHON_VERSION: '3.11'

jobs:
  deploy:
    name: Deploy AI to Prod (V2 - Docker)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    concurrency:
      group: deploy-ai-prod-v2
      cancel-in-progress: false
    environment: production

    steps:
      - name: Checkout
        if: inputs.use_existing_image == false
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha || 'main' }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set Deployment Variables
        id: deploy-vars
        run: |
          if [ "${{ inputs.use_existing_image }}" == "true" ]; then
            if [ -n "${{ inputs.image_tag }}" ]; then
              IMAGE_TAG="${{ inputs.image_tag }}"
              echo "üì¶ Using specified image tag: ${IMAGE_TAG}"
            else
              IMAGE_TAG="main-latest"
              echo "üì¶ Using main-latest (no image_tag provided)"
            fi
            SHA_SHORT=$(echo "${IMAGE_TAG}" | sed -n 's/^main-\([a-f0-9]\{7\}\)$/\1/p')
            [ -z "${SHA_SHORT}" ] && SHA_SHORT="latest"
            echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
            echo "sha=${IMAGE_TAG}" >> $GITHUB_OUTPUT
            echo "sha_short=${SHA_SHORT}" >> $GITHUB_OUTPUT
          else
            SHA="${{ inputs.sha || github.sha }}"
            SHA_SHORT="${SHA:0:7}"
            if [ -n "${{ inputs.image_tag }}" ]; then
              IMAGE_TAG="${{ inputs.image_tag }}"
            else
              IMAGE_TAG="main-${SHA_SHORT}"
            fi
            echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
            echo "sha=${SHA}" >> $GITHUB_OUTPUT
            echo "sha_short=${SHA_SHORT}" >> $GITHUB_OUTPUT
            echo "üì¶ Using image: ${IMAGE_TAG}"
          fi

      - name: Set up Docker Buildx
        if: inputs.use_existing_image == false
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Docker Image
        if: inputs.use_existing_image == false
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY_AI }}:${{ steps.deploy-vars.outputs.image_tag }}
            ${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY_AI }}:main-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/arm64

      - name: Verify Image Exists in ECR
        if: inputs.use_existing_image == true
        run: |
          IMAGE_TAG="${{ steps.deploy-vars.outputs.image_tag }}"
          REPO="${{ secrets.ECR_REPOSITORY_AI }}"

          aws ecr describe-images \
            --repository-name "${REPO}" \
            --image-ids imageTag="${IMAGE_TAG}" \
            --region ap-northeast-2 > /dev/null 2>&1

          if [ $? -eq 0 ]; then
            echo "‚úÖ Image found: ${REPO}:${IMAGE_TAG}"
          else
            echo "‚ùå Image not found: ${REPO}:${IMAGE_TAG}"
            exit 1
          fi

      - name: Deploy to Prod EC2 via SSM (Docker)
        id: deploy
        env:
          SERVER_BASE_PATH: ${{ secrets.SERVER_BASE_PATH }}
          EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
          HEALTH_CHECK_URL: ${{ secrets.HEALTH_CHECK_URL }}
          PROD_COMPOSE_DIR: ${{ secrets.PROD_COMPOSE_DIR }}
          AI_ENV_FILE_PROD: ${{ secrets.AI_ENV_FILE_PROD }}
        run: |
          set -euo pipefail

          AI_HEALTH_URL="${HEALTH_CHECK_URL%/health}/api/ai/health"
          COMPOSE_DIR="${PROD_COMPOSE_DIR:-${SERVER_BASE_PATH}/docker}"
          ECR_REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          ECR_REPO="${{ secrets.ECR_REPOSITORY_AI }}"
          IMAGE_TAG="${{ steps.deploy-vars.outputs.image_tag }}"
          FULL_IMAGE="${ECR_REGISTRY}/${ECR_REPO}:${IMAGE_TAG}"

          DEPLOY_SCRIPT=$(cat <<'SCRIPT_END'
          set -euo pipefail
          COMPOSE_DIR="$1"
          FULL_IMAGE="$2"
          IMAGE_TAG="$3"
          HEALTH_CHECK_URL="$4"
          AI_ENV_FILE="$5"

          echo "============================================"
          echo "Re-Fit AI ÌîÑÎ°úÎçïÏÖò Î∞∞Ìè¨ (V2-Docker): $(date)"
          echo "============================================"

          if [ ! -d "$COMPOSE_DIR" ]; then
            echo "‚ùå Compose directory not found: $COMPOSE_DIR"
            exit 1
          fi

          echo "üê≥ Image: ${FULL_IMAGE}"
          echo "üìÅ Compose dir: ${COMPOSE_DIR}"

          aws ecr get-login-password --region ap-northeast-2 | \
            docker login --username AWS --password-stdin "$(echo ${FULL_IMAGE} | cut -d/ -f1)"

          cd "$COMPOSE_DIR"

          if [ -n "$AI_ENV_FILE" ]; then
            echo "$AI_ENV_FILE" > .env.ai
            chmod 644 .env.ai
            echo "üîê .env.ai Ï£ºÏûÖ ÏôÑÎ£å"
          fi

          if grep -q '^AI_TAG=' .env 2>/dev/null; then
            sed -i "s|^AI_TAG=.*|AI_TAG=${IMAGE_TAG}|" .env
          else
            echo "AI_TAG=${IMAGE_TAG}" >> .env
          fi

          echo "üì• Pulling new image..."
          docker compose pull ai || docker compose pull 2>/dev/null || true

          echo "üîÑ Restarting ai service..."
          docker compose up -d ai || docker compose up -d 2>/dev/null || true

          docker image prune -f 2>/dev/null || true
          echo "ÏÑúÎπÑÏä§ Ï¥àÍ∏∞Ìôî ÎåÄÍ∏∞ (30Ï¥à)..."
          sleep 30

          systemctl is-active --quiet caddy && sudo systemctl reload caddy 2>/dev/null || true
          sleep 2

          for i in {1..15}; do
            HTTP_STATUS=$(timeout 10 curl -s -o /dev/null -w "%{http_code}" "$HEALTH_CHECK_URL" 2>/dev/null || echo "000")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "‚úÖ Ìó¨Ïä§Ï≤¥ÌÅ¨ ÏÑ±Í≥µ!"
              exit 0
            fi
            echo "‚ö†Ô∏è ÏãúÎèÑ $i/15: HTTP $HTTP_STATUS"
            [ $i -lt 15 ] && sleep 5
          done

          echo "‚ùå Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìå®"
          exit 1
          SCRIPT_END
          )

          DEPLOY_SCRIPT_ENCODED=$(echo "$DEPLOY_SCRIPT" | base64 -w 0)
          SSM_COMMAND="bash -c \"echo '$DEPLOY_SCRIPT_ENCODED' | base64 -d | bash -s -- '$COMPOSE_DIR' '$FULL_IMAGE' '$IMAGE_TAG' '$AI_HEALTH_URL' '$AI_ENV_FILE_PROD'\""
          PARAMETERS_JSON=$(jq -n --arg cmd "$SSM_COMMAND" '{commands: [$cmd]}')

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$EC2_INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters "$PARAMETERS_JSON" \
            --timeout-seconds 1800 \
            --region ap-northeast-2 \
            --query 'Command.CommandId' \
            --output text)

          [ -n "$COMMAND_ID" ] || exit 1

          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$EC2_INSTANCE_ID" \
              --region ap-northeast-2 \
              --query 'Status' \
              --output text 2>/dev/null || echo "InProgress")

            if [ "$STATUS" = "Success" ]; then
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$EC2_INSTANCE_ID" \
                --region ap-northeast-2 \
                --query 'StandardOutputContent' \
                --output text
              exit 0
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$EC2_INSTANCE_ID" \
                --region ap-northeast-2 \
                --query 'StandardOutputContent' --output text
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$EC2_INSTANCE_ID" \
                --region ap-northeast-2 \
                --query 'StandardErrorContent' --output text
              exit 1
            fi
            [ $i -lt 60 ] && sleep 5
          done

          echo "SSM Command timeout"
          exit 1

      - name: Notify Discord - Success
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          SHA_SHORT="${{ steps.deploy-vars.outputs.sha_short }}"
          IMAGE_TAG="${{ steps.deploy-vars.outputs.image_tag }}"

          payload=$(cat <<EOF
          {
            "embeds": [{
              "title": "üöÄ AI ÌîÑÎ°úÎçïÏÖò Î∞∞Ìè¨ ÏôÑÎ£å (V2-Docker)",
              "description": "Docker Í∏∞Î∞ò AI ÌîÑÎ°úÎçïÏÖò Î∞∞Ìè¨Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.",
              "color": 3066993,
              "fields": [
                {"name": "ÏÑúÎπÑÏä§", "value": "Re-Fit AI (Prod)", "inline": true},
                {"name": "Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏", "value": "\`${IMAGE_TAG}\`", "inline": true},
                {"name": "Ïª§Î∞ã SHA", "value": "\`${SHA_SHORT}\`", "inline": true},
                {"name": "ÏõåÌÅ¨ÌîåÎ°úÏö∞", "value": "[ÏÉÅÏÑ∏ Î≥¥Í∏∞](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
              ],
              "footer": { "text": "Re-Fit AI Prod Deployment (V2-Docker)" },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )
          curl -H "Content-Type: application/json" -X POST -d "$payload" "$DISCORD_WEBHOOK"

      - name: Notify Discord - Failure
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          SHA_SHORT="${{ steps.deploy-vars.outputs.sha_short }}"
          IMAGE_TAG="${{ steps.deploy-vars.outputs.image_tag }}"

          payload=$(cat <<EOF
          {
            "embeds": [{
              "title": "üö® AI ÌîÑÎ°úÎçïÏÖò Î∞∞Ìè¨ Ïã§Ìå® (V2-Docker)",
              "description": "Docker Í∏∞Î∞ò AI ÌîÑÎ°úÎçïÏÖò Î∞∞Ìè¨Í∞Ä Ïã§Ìå®ÌñàÏäµÎãàÎã§.",
              "color": 15158332,
              "fields": [
                {"name": "ÏÑúÎπÑÏä§", "value": "Re-Fit AI (Prod)", "inline": true},
                {"name": "Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏", "value": "\`${IMAGE_TAG}\`", "inline": true},
                {"name": "Ïª§Î∞ã SHA", "value": "\`${SHA_SHORT}\`", "inline": true},
                {"name": "ÏõåÌÅ¨ÌîåÎ°úÏö∞", "value": "[ÏÉÅÏÑ∏ Î≥¥Í∏∞](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
              ],
              "footer": { "text": "Re-Fit AI Prod Deployment (V2-Docker)" },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )
          curl -H "Content-Type: application/json" -X POST -d "$payload" "$DISCORD_WEBHOOK"