name: AI Service Rollback

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Operation Mode'
        required: true
        type: choice
        options:
          - list
          - restore
        default: 'list'
      backup_id:
        description: 'Backup ID to restore (required for restore mode, e.g., ai_20240127120000)'
        required: false
        type: string
      restore_dependencies:
        description: 'Restore dependencies (wheel package)'
        required: true
        type: boolean
        default: true

jobs:
  rollback:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Execute Rollback Operation
        env:
          SERVER_BASE_PATH: ${{ secrets.SERVER_BASE_PATH }}
          EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
          HEALTH_CHECK_URL: ${{ secrets.HEALTH_CHECK_URL }}
          S3_BUCKET: ${{ secrets.S3_ARTIFACTS_BUCKET }}
          MODE: ${{ inputs.mode }}
          BACKUP_ID: ${{ inputs.backup_id }}
          RESTORE_DEPS: ${{ inputs.restore_dependencies }}
        run: |
          set -euo pipefail

          BASE_PATH="$SERVER_BASE_PATH"
          AI_DIR="${BASE_PATH}/app/ai"
          AI_APP_DIR="${AI_DIR}/ai_app"
          BACKUP_DIR="${BASE_PATH}/backups/ai"
          PM2_CONFIG="${BASE_PATH}/infra/pm2/ecosystem.ai.config.js"

          SCRIPT=$(cat <<'SCRIPT_END'
          set -euo pipefail
          BASE_PATH="$1"
          AI_DIR="$2"
          AI_APP_DIR="$3"
          BACKUP_DIR="$4"
          PM2_CONFIG="$5"
          MODE="$6"
          BACKUP_ID="$7"
          HEALTH_CHECK_URL="$8"
          S3_BUCKET="$9"
          RESTORE_DEPS="${10}"

          APP_NAME="ai-service"
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          
          # Ìó¨Ïä§Ï≤¥ÌÅ¨ URL ÏàòÏ†ï (/health ‚Üí /api/ai/health)
          AI_HEALTH_URL="${HEALTH_CHECK_URL%/health}/api/ai/health"

          echo "============================================"
          echo "Re-Fit AI Rollback Operation: ${MODE}"
          echo "Time: $(date)"
          echo "============================================"

          # ========================================
          # MODE: list - Î∞±ÏóÖ Î™©Î°ù Ï°∞Ìöå
          # ========================================
          if [ "${MODE}" = "list" ]; then
            echo ""
            echo "üìÇ Available Code Backups (Latest 10):"
            if [ -d "${BACKUP_DIR}" ]; then
              ls -lt "${BACKUP_DIR}" | grep "^d" | grep "code_" | head -n 10 | awk '{print "  -", $9, "(" $6, $7, $8 ")"}'
            else
              echo "  No backups directory found."
            fi

            echo ""
            echo "üì¶ Available Wheel Backups (Latest 10):"
            if [ -d "${BACKUP_DIR}" ]; then
              ls -lt "${BACKUP_DIR}" | grep "^d" | grep "wheel_" | head -n 10 | awk '{print "  -", $9, "(" $6, $7, $8 ")"}'
            else
              echo "  No wheel backups found."
            fi

            echo ""
            echo "üí° Usage:"
            echo "  - Code backup ID format: code_20240127120000"
            echo "  - Wheel backup ID format: wheel_20240127120000"
            echo "  - Use the same timestamp for code and wheel to ensure compatibility"
            echo ""
            exit 0
          fi

          # ========================================
          # MODE: restore - Î°§Î∞± Ïã§Ìñâ
          # ========================================
          if [ "${MODE}" = "restore" ]; then
            TARGET_CODE_BACKUP=""
            TARGET_WHEEL_BACKUP=""

            # 1. Î∞±ÏóÖ ID Í≤∞Ï†ï
            if [ -z "${BACKUP_ID}" ]; then
              # Í∞ÄÏû• ÏµúÏã† Î∞±ÏóÖ Ï∞æÍ∏∞
              LATEST_CODE=$(ls -td "${BACKUP_DIR}/code_"* 2>/dev/null | head -n 1)
              if [ -z "$LATEST_CODE" ]; then
                echo "‚ùå Error: No code backup found"
                exit 1
              fi
              BACKUP_TIMESTAMP=$(basename "$LATEST_CODE" | sed 's/code_//')
              TARGET_CODE_BACKUP="$LATEST_CODE"
              TARGET_WHEEL_BACKUP="${BACKUP_DIR}/wheel_${BACKUP_TIMESTAMP}"
              echo "‚ö†Ô∏è  Backup ID not specified. Using latest: code_${BACKUP_TIMESTAMP}"
            else
              # ÏÇ¨Ïö©ÏûêÍ∞Ä ÏßÄÏ†ïÌïú Î∞±ÏóÖ ÏÇ¨Ïö©
              if [[ "$BACKUP_ID" =~ ^code_ ]]; then
                BACKUP_TIMESTAMP=$(echo "$BACKUP_ID" | sed 's/code_//')
                TARGET_CODE_BACKUP="${BACKUP_DIR}/code_${BACKUP_TIMESTAMP}"
                TARGET_WHEEL_BACKUP="${BACKUP_DIR}/wheel_${BACKUP_TIMESTAMP}"
              elif [[ "$BACKUP_ID" =~ ^wheel_ ]]; then
                BACKUP_TIMESTAMP=$(echo "$BACKUP_ID" | sed 's/wheel_//')
                TARGET_CODE_BACKUP="${BACKUP_DIR}/code_${BACKUP_TIMESTAMP}"
                TARGET_WHEEL_BACKUP="${BACKUP_DIR}/wheel_${BACKUP_TIMESTAMP}"
              else
                # timestampÎßå ÏûÖÎ†•Ìïú Í≤ΩÏö∞
                BACKUP_TIMESTAMP="$BACKUP_ID"
                TARGET_CODE_BACKUP="${BACKUP_DIR}/code_${BACKUP_TIMESTAMP}"
                TARGET_WHEEL_BACKUP="${BACKUP_DIR}/wheel_${BACKUP_TIMESTAMP}"
              fi
            fi

            # 2. Î∞±ÏóÖ Ï°¥Ïû¨ ÌôïÏù∏
            if [ ! -d "${TARGET_CODE_BACKUP}" ]; then
              echo "‚ùå Error: Code backup not found: ${TARGET_CODE_BACKUP}"
              exit 1
            fi
            echo "‚úÖ Code backup found: ${TARGET_CODE_BACKUP}"

            if [ "${RESTORE_DEPS}" = "true" ]; then
              if [ ! -d "${TARGET_WHEEL_BACKUP}" ]; then
                echo "‚ö†Ô∏è  Warning: Wheel backup not found: ${TARGET_WHEEL_BACKUP}"
                echo "‚ö†Ô∏è  Continuing with code rollback only..."
                RESTORE_DEPS="false"
              else
                echo "‚úÖ Wheel backup found: ${TARGET_WHEEL_BACKUP}"
              fi
            fi

            echo ""
            echo "üîÑ Rollback Plan:"
            echo "  - Code: ${TARGET_CODE_BACKUP}"
            if [ "${RESTORE_DEPS}" = "true" ]; then
              echo "  - Wheel: ${TARGET_WHEEL_BACKUP}"
            else
              echo "  - Wheel: Skip (current dependencies will be used)"
            fi
            echo ""

            # 3. Safety Backup (ÌòÑÏû¨ ÏÉÅÌÉú ÏûÑÏãú Î∞±ÏóÖ)
            SAFETY_BACKUP="${BACKUP_DIR}/safety_before_rollback_${TIMESTAMP}"
            echo "üõ°Ô∏è  Creating safety backup..."
            mkdir -p "${SAFETY_BACKUP}"
            
            if [ -d "${AI_APP_DIR}" ]; then
              cp -r "${AI_APP_DIR}" "${SAFETY_BACKUP}/"
              echo "‚úÖ Safety backup created: ${SAFETY_BACKUP}"
            fi

            # ÌòÑÏû¨ ÏÑ§ÏπòÎêú wheel Ï†ïÎ≥¥ÎèÑ Î∞±ÏóÖ
            if [ -f "${AI_DIR}/deploy_temp/current_wheel.txt" ]; then
              cp "${AI_DIR}/deploy_temp/current_wheel.txt" "${SAFETY_BACKUP}/"
            fi

            # 4. PM2 ÌîÑÎ°úÏÑ∏Ïä§ ÏôÑÏ†Ñ Ï†ïÎ¶¨
            echo ""
            echo "üßπ Stopping all AI-related PM2 processes..."
            sudo -u ubuntu pm2 list | grep -E 'ai-service|ai-serv' | awk '{print $2}' | while read -r process_name; do
              if [ -n "$process_name" ] && [ "$process_name" != "name" ]; then
                echo "  - Stopping: $process_name"
                sudo -u ubuntu pm2 stop "$process_name" 2>/dev/null || true
                sudo -u ubuntu pm2 delete "$process_name" 2>/dev/null || true
              fi
            done

            # 5. Ìè¨Ìä∏ Ï†ïÎ¶¨
            echo "üîå Killing processes on port 8000..."
            sudo lsof -ti:8000 | xargs -r sudo kill -9 2>/dev/null || true
            sleep 1

            # 6. ÏΩîÎìú Î≥µÏõê
            echo ""
            echo "üìÅ Restoring code files..."
            sudo rm -rf "${AI_APP_DIR}"
            sudo cp -r "${TARGET_CODE_BACKUP}" "${AI_APP_DIR}"
            echo "‚úÖ Code files restored"

            # 7. ÏÑ§Ï†ï ÌååÏùº Î≥µÏõê (Î∞±ÏóÖ ÎÇ¥Î∂Ä ÎòêÎäî AI_DIRÏóêÏÑú Ï∞æÍ∏∞)
            if [ -f "${TARGET_CODE_BACKUP}/pyproject.toml" ]; then
              sudo cp "${TARGET_CODE_BACKUP}/pyproject.toml" "${AI_DIR}/" 2>/dev/null || true
              echo "‚úÖ pyproject.toml restored from backup"
            elif [ -f "${AI_DIR}/pyproject.toml" ]; then
              echo "‚ÑπÔ∏è  Using existing pyproject.toml"
            fi

            if [ -f "${TARGET_CODE_BACKUP}/requirements.txt" ]; then
              sudo cp "${TARGET_CODE_BACKUP}/requirements.txt" "${AI_APP_DIR}/" 2>/dev/null || true
              echo "‚úÖ requirements.txt restored from backup"
            elif [ -f "${AI_APP_DIR}/requirements.txt" ]; then
              echo "‚ÑπÔ∏è  Using existing requirements.txt"
            fi

            # 8. ÏùòÏ°¥ÏÑ± Î≥µÏõê (ÏÑ†ÌÉùÏ†Å)
            if [ "${RESTORE_DEPS}" = "true" ]; then
              echo ""
              echo "üì¶ Restoring dependencies..."
              
              WHEEL_FILE=$(ls "${TARGET_WHEEL_BACKUP}"/*.whl 2>/dev/null | head -n 1)
              if [ -n "$WHEEL_FILE" ]; then
                echo "Installing: $(basename $WHEEL_FILE)"
                "${AI_DIR}/venv/bin/pip" install "$WHEEL_FILE" --force-reinstall --no-cache-dir 2>&1 | tail -20
                echo "‚úÖ Dependencies restored from wheel"
              else
                echo "‚ö†Ô∏è  No wheel file found in backup, using current dependencies"
              fi
            else
              echo ""
              echo "‚ö†Ô∏è  Skipping dependency restoration (current venv will be used)"
            fi

            # 9. Í∂åÌïú Î≥µÍµ¨
            sudo chown -R ubuntu:ubuntu "${AI_APP_DIR}" 2>/dev/null || true
            sudo chown -R ubuntu:ubuntu "${AI_DIR}" 2>/dev/null || true

            # 10. PM2Î°ú ÏÑúÎπÑÏä§ Ïû¨ÏãúÏûë
            echo ""
            echo "üöÄ Starting AI service..."
            sudo -u ubuntu pm2 start "${PM2_CONFIG}" --only ${APP_NAME} --env production || {
              echo "‚ùå Failed to start PM2 process"
              echo ""
              echo "üîô Attempting to restore from safety backup..."
              
              # Safety backupÏúºÎ°ú Î≥µÍµ¨ ÏãúÎèÑ
              if [ -d "${SAFETY_BACKUP}/ai_app" ]; then
                sudo rm -rf "${AI_APP_DIR}"
                sudo cp -r "${SAFETY_BACKUP}/ai_app" "${AI_APP_DIR}"
                sudo chown -R ubuntu:ubuntu "${AI_APP_DIR}"
                sudo -u ubuntu pm2 start "${PM2_CONFIG}" --only ${APP_NAME} --env production || true
              fi
              exit 1
            }

            sleep 3

            # 11. PM2 ÏÉÅÌÉú ÌôïÏù∏
            sudo -u ubuntu pm2 describe ${APP_NAME} > /dev/null || {
              echo "‚ùå PM2 process not running after start"
              exit 1
            }
            echo "‚úÖ PM2 process started"

            # 12. Caddy Î¶¨Î°úÎìú
            echo ""
            echo "üîÑ Reloading Caddy..."
            systemctl is-active --quiet caddy && sudo systemctl reload caddy 2>/dev/null || true
            sleep 5

            # 13. Ìó¨Ïä§Ï≤¥ÌÅ¨ (ÏµúÎåÄ 10Ìöå Ïû¨ÏãúÎèÑ, Ï†êÏßÑÏ†Å ÎåÄÍ∏∞)
            echo ""
            echo "üè• Running health checks..."
            RETRY_COUNT=0
            MAX_RETRIES=10
            
            for i in $(seq 1 $MAX_RETRIES); do
              # ÎåÄÍ∏∞ ÏãúÍ∞ÑÏùÑ Ï†êÏßÑÏ†ÅÏúºÎ°ú Ï¶ùÍ∞Ä (Ï≤´ ÏãúÎèÑ: 2Ï¥à, Ïù¥ÌõÑ: 3-5Ï¥à)
              if [ $i -eq 1 ]; then
                sleep 2
              else
                sleep $((2 + i / 2))
              fi

              HTTP_STATUS=$(timeout 10 curl -s -o /dev/null -w "%{http_code}" "${AI_HEALTH_URL}" 2>/dev/null || echo "000")
              
              if [ "${HTTP_STATUS}" = "200" ]; then
                echo "‚úÖ Rollback successful! Service is healthy (HTTP ${HTTP_STATUS})"
                echo ""
                
                # PM2 ÏÉÅÌÉú Ï†ÄÏû•
                sudo -u ubuntu pm2 save 2>/dev/null || true
                
                # ÏÑúÎπÑÏä§ ÏÉÅÌÉú Ï∂úÎ†•
                echo "üìä Service Status:"
                sudo -u ubuntu pm2 status ${APP_NAME}
                echo ""
                
                # Safety backup Ï†ïÎ¶¨ (ÏÑ±Í≥µ Ïãú)
                echo "üóëÔ∏è  Cleaning up safety backup..."
                rm -rf "${SAFETY_BACKUP}"
                
                # 7Ïùº Ïù¥ÏÉÅ Îêú Î∞±ÏóÖ Ï†ïÎ¶¨ (Î∞±Í∑∏ÎùºÏö¥Îìú)
                (find "${BACKUP_DIR}" -type d \( -name "code_*" -o -name "wheel_*" -o -name "safety_*" \) -mtime +7 -exec rm -rf {} + 2>/dev/null) &
                
                echo "============================================"
                echo "Re-Fit AI Rollback Complete: $(date)"
                echo "============================================"
                exit 0
              fi
              
              echo "‚ö†Ô∏è  Attempt $i/$MAX_RETRIES: HTTP ${HTTP_STATUS}"
              RETRY_COUNT=$i
            done

            # 14. Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìå® - Îã§Îã®Í≥Ñ Î≥µÍµ¨ ÏãúÎèÑ
            echo ""
            echo "‚ùå Health check failed after ${RETRY_COUNT} attempts"
            echo ""
            echo "üîç Checking PM2 logs..."
            sudo -u ubuntu pm2 logs ${APP_NAME} --lines 30 --nostream || true
            
            echo ""
            echo "üîô Final attempt: Restoring from safety backup..."
            
            if [ -d "${SAFETY_BACKUP}/ai_app" ]; then
              # Safety backupÏúºÎ°ú ÏôÑÏ†Ñ Î≥µÍµ¨
              sudo rm -rf "${AI_APP_DIR}"
              sudo cp -r "${SAFETY_BACKUP}/ai_app" "${AI_APP_DIR}"
              sudo chown -R ubuntu:ubuntu "${AI_APP_DIR}"
              
              # PM2 Ïû¨ÏãúÏûë
              sudo lsof -ti:8000 | xargs -r sudo kill -9 2>/dev/null || true
              sudo -u ubuntu pm2 list | grep -E 'ai-service|ai-serv' | awk '{print $2}' | while read -r pname; do
                [ -n "$pname" ] && [ "$pname" != "name" ] && sudo -u ubuntu pm2 delete "$pname" 2>/dev/null || true
              done
              
              sudo -u ubuntu pm2 start "${PM2_CONFIG}" --only ${APP_NAME} --env production
              sleep 5
              
              # ÏµúÏ¢Ö Ìó¨Ïä§Ï≤¥ÌÅ¨
              HTTP_STATUS=$(timeout 10 curl -s -o /dev/null -w "%{http_code}" "${AI_HEALTH_URL}" 2>/dev/null || echo "000")
              if [ "${HTTP_STATUS}" = "200" ]; then
                echo "‚úÖ Recovered using safety backup!"
                sudo -u ubuntu pm2 save 2>/dev/null || true
                exit 0
              fi
            fi
            
            echo ""
            echo "‚ùå All recovery attempts failed"
            echo "üö® Manual intervention required!"
            echo ""
            echo "Debug Information:"
            echo "  - Safety backup: ${SAFETY_BACKUP}"
            echo "  - Code backup: ${TARGET_CODE_BACKUP}"
            echo "  - Wheel backup: ${TARGET_WHEEL_BACKUP}"
            echo "  - PM2 config: ${PM2_CONFIG}"
            echo ""
            exit 1
          fi
          SCRIPT_END
          )
          
          # SSM Î™ÖÎ†π Ïã§Ìñâ
          SCRIPT_ENCODED=$(echo "$SCRIPT" | base64 -w 0)
          SSM_COMMAND="bash -c \"echo '$SCRIPT_ENCODED' | base64 -d | bash -s -- '$BASE_PATH' '$AI_DIR' '$AI_APP_DIR' '$BACKUP_DIR' '$PM2_CONFIG' '$MODE' '$BACKUP_ID' '$HEALTH_CHECK_URL' '$S3_BUCKET' '$RESTORE_DEPS'\""
          
          PARAMETERS_JSON=$(jq -n --arg cmd "$SSM_COMMAND" '{commands: [$cmd]}')
          
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$EC2_INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters "$PARAMETERS_JSON" \
            --timeout-seconds 1200 \
            --region ap-northeast-2 \
            --query 'Command.CommandId' \
            --output text)
            
          [ -n "$COMMAND_ID" ] || exit 1
          
          echo "SSM Command ID: $COMMAND_ID"
          echo "Waiting for rollback operation to complete..."
          
          # Ïã§Ìñâ ÏÉÅÌÉú ÌôïÏù∏
          for i in {1..120}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$EC2_INSTANCE_ID" \
              --region ap-northeast-2 \
              --query 'Status' \
              --output text 2>/dev/null || echo "InProgress")
            
            if [ "$STATUS" = "Success" ]; then
              echo ""
              echo "=== Rollback Output ==="
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$EC2_INSTANCE_ID" \
                --region ap-northeast-2 \
                --query 'StandardOutputContent' \
                --output text
              exit 0
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              echo ""
              echo "=== Rollback Error ==="
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$EC2_INSTANCE_ID" \
                --region ap-northeast-2 \
                --query 'StandardErrorContent' \
                --output text
              exit 1
            fi
            
            # ÏßÑÌñâ ÏÉÅÌô© ÌëúÏãú
            if [ $((i % 10)) -eq 0 ]; then
              echo "Still in progress... (${i}s elapsed)"
            fi
            sleep 3
          done
          
          echo "Timeout waiting for rollback operation"
          exit 1

      - name: Notify Discord on Result
        if: always() && inputs.mode == 'restore'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          STATUS: ${{ job.status }}
          BACKUP_ID: ${{ inputs.backup_id }}
          RESTORE_DEPS: ${{ inputs.restore_dependencies }}
          RUN_ID: ${{ github.run_id }}
        run: |
          # ÏÉÅÌÉúÏóê Îî∞Î•∏ ÏÉâÏÉÅ Î∞è Ïù¥Î™®ÏßÄ ÏÑ§Ï†ï
          if [ "$STATUS" = "success" ]; then
            COLOR=3066993
            EMOJI="üîÑ"
            TITLE="Rollback Successful"
          else
            COLOR=15158332
            EMOJI="üö®"
            TITLE="Rollback Failed"
          fi

          # Backup ID ÌëúÏãú
          BACKUP_TEXT="${BACKUP_ID:-ÏµúÏã† Î∞±ÏóÖ}"
          
          # ÏùòÏ°¥ÏÑ± Î≥µÏõê Ïó¨Î∂Ä
          DEPS_TEXT="No"
          [ "$RESTORE_DEPS" = "true" ] && DEPS_TEXT="Yes (wheel package restored)"

          # JSON ÌéòÏù¥Î°úÎìú ÏÉùÏÑ±
          payload=$(cat <<EOF
          {
            "embeds": [{
              "title": "$EMOJI AI Î°§Î∞± Í≤∞Í≥º: $TITLE",
              "color": $COLOR,
              "fields": [
                {"name": "ÏÑúÎπÑÏä§", "value": "Re-Fit AI", "inline": true},
                {"name": "ÏÉÅÌÉú", "value": "\`$STATUS\`", "inline": true},
                {"name": "Î°§Î∞± ÎåÄÏÉÅ", "value": "\`$BACKUP_TEXT\`", "inline": false},
                {"name": "ÏùòÏ°¥ÏÑ± Î≥µÏõê", "value": "$DEPS_TEXT", "inline": true},
                {"name": "ÏõåÌÅ¨ÌîåÎ°úÏö∞", "value": "[ÏÉÅÏÑ∏ Î≥¥Í∏∞](https://github.com/${{ github.repository }}/actions/runs/$RUN_ID)", "inline": false}
              ],
              "footer": { "text": "Re-Fit AI Rollback System" },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )

          # Ï†ÑÏÜ°
          curl -H "Content-Type: application/json" -X POST -d "$payload" "$DISCORD_WEBHOOK"
