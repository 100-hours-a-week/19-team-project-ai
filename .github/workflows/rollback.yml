name: AI Service Rollback

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Operation Mode'
        required: true
        type: choice
        options:
          - list
          - restore
        default: 'list'
      backup_id:
        description: 'Backup ID to restore (e.g., 20240127120000 or code_20240127120000)'
        required: false
        type: string
      restore_dependencies:
        description: 'Restore dependencies (wheel package)'
        required: true
        type: boolean
        default: true

jobs:
  rollback:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Execute Rollback Operation
        id: rollback
        env:
          SERVER_BASE_PATH: ${{ secrets.SERVER_BASE_PATH }}
          EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
          HEALTH_CHECK_URL: ${{ secrets.HEALTH_CHECK_URL }}
          MODE: ${{ inputs.mode }}
          BACKUP_ID: ${{ inputs.backup_id }}
          RESTORE_DEPS: ${{ inputs.restore_dependencies }}
        run: |
          set -euo pipefail

          BASE_PATH="$SERVER_BASE_PATH"
          AI_DIR="${BASE_PATH}/app/ai"
          AI_APP_DIR="${AI_DIR}/ai_app"
          BACKUP_DIR="${BASE_PATH}/backups/ai"
          PM2_CONFIG="${BASE_PATH}/infra/pm2/ecosystem.ai.config.js"

          SCRIPT=$(cat <<'SCRIPT_END'
          set -euo pipefail
          BASE_PATH="$1"
          AI_DIR="$2"
          AI_APP_DIR="$3"
          BACKUP_DIR="$4"
          PM2_CONFIG="$5"
          MODE="$6"
          BACKUP_ID="$7"
          HEALTH_CHECK_URL="$8"
          RESTORE_DEPS="$9"

          APP_NAME="ai-service"
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          
          # Ìó¨Ïä§Ï≤¥ÌÅ¨ URL ÏàòÏ†ï
          AI_HEALTH_URL="${HEALTH_CHECK_URL%/health}/api/ai/health"

          echo "============================================"
          echo "Re-Fit AI Rollback: ${MODE}"
          echo "Time: $(date)"
          echo "============================================"

          # ========================================
          # MODE: list - Î∞±ÏóÖ Î™©Î°ù Ï°∞Ìöå
          # ========================================
          if [ "${MODE}" = "list" ]; then
            echo ""
            echo "üìÇ Available Backups (Latest 10):"
            echo ""
            
            if [ -d "${BACKUP_DIR}" ]; then
              # ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÎ≥ÑÎ°ú Í∑∏Î£πÌôîÌïòÏó¨ ÌëúÏãú
              ls -t "${BACKUP_DIR}" | grep -E "^(code|wheel)_[0-9]{14}$" | \
                sed 's/^[^_]*_//' | sort -u -r | head -n 10 | while read -r ts; do
                
                CODE_PATH="${BACKUP_DIR}/code_${ts}"
                WHEEL_PATH="${BACKUP_DIR}/wheel_${ts}"
                
                CODE_EXISTS="‚ùå"
                WHEEL_EXISTS="‚ùå"
                
                [ -d "$CODE_PATH" ] && CODE_EXISTS="‚úÖ"
                [ -d "$WHEEL_PATH" ] && WHEEL_EXISTS="‚úÖ"
                
                # Î∞±ÏóÖ ÏãúÍ∞Ñ Ìè¨Îß∑ÌåÖ
                YEAR=${ts:0:4}
                MONTH=${ts:4:2}
                DAY=${ts:6:2}
                HOUR=${ts:8:2}
                MIN=${ts:10:2}
                SEC=${ts:12:2}
                
                echo "  üì¶ Backup: ${ts}"
                echo "     Date: ${YEAR}-${MONTH}-${DAY} ${HOUR}:${MIN}:${SEC}"
                echo "     Code: ${CODE_EXISTS}  Wheel: ${WHEEL_EXISTS}"
                echo ""
              done
            else
              echo "  No backups found."
            fi

            echo ""
            echo "üí° Usage:"
            echo "  - Use timestamp (e.g., 20240127120000) for backup_id"
            echo "  - Restore with: mode=restore, backup_id=<timestamp>"
            echo ""
            exit 0
          fi

          # ========================================
          # MODE: restore - Î°§Î∞± Ïã§Ìñâ
          # ========================================
          if [ "${MODE}" = "restore" ]; then
            # 1. Î∞±ÏóÖ ID Í≤∞Ï†ï Î∞è Í≤ÄÏ¶ù
            if [ -z "${BACKUP_ID}" ]; then
              # Í∞ÄÏû• ÏµúÏã† Î∞±ÏóÖ ÏûêÎèô ÏÑ†ÌÉù
              LATEST_BACKUP=$(ls -t "${BACKUP_DIR}" | grep -E "^code_[0-9]{14}$" | head -n 1)
              if [ -z "$LATEST_BACKUP" ]; then
                echo "‚ùå No backups found"
                exit 1
              fi
              BACKUP_TIMESTAMP=$(echo "$LATEST_BACKUP" | sed 's/code_//')
              echo "‚ö†Ô∏è  Backup ID not specified. Using latest: ${BACKUP_TIMESTAMP}"
            else
              # ÏÇ¨Ïö©Ïûê ÏßÄÏ†ï Î∞±ÏóÖ ID ÌååÏã±
              BACKUP_TIMESTAMP=$(echo "$BACKUP_ID" | sed -E 's/^(code_|wheel_)//g')
            fi
            
            TARGET_CODE_BACKUP="${BACKUP_DIR}/code_${BACKUP_TIMESTAMP}"
            TARGET_WHEEL_BACKUP="${BACKUP_DIR}/wheel_${BACKUP_TIMESTAMP}"
            
            # 2. Î∞±ÏóÖ Ï°¥Ïû¨ ÌôïÏù∏
            if [ ! -d "${TARGET_CODE_BACKUP}" ]; then
              echo "‚ùå Code backup not found: ${TARGET_CODE_BACKUP}"
              echo ""
              echo "Available backups:"
              ls -l "${BACKUP_DIR}" | grep "^d" | grep "code_"
              exit 1
            fi
            echo "‚úÖ Code backup found: ${TARGET_CODE_BACKUP}"
            
            if [ "${RESTORE_DEPS}" = "true" ]; then
              if [ ! -d "${TARGET_WHEEL_BACKUP}" ]; then
                echo "‚ö†Ô∏è  Wheel backup not found: ${TARGET_WHEEL_BACKUP}"
                echo "‚ö†Ô∏è  Continuing with code rollback only"
                RESTORE_DEPS="false"
              else
                echo "‚úÖ Wheel backup found: ${TARGET_WHEEL_BACKUP}"
              fi
            fi
            
            echo ""
            echo "üîÑ Rollback Plan:"
            echo "  - Backup: ${BACKUP_TIMESTAMP}"
            echo "  - Code: ${TARGET_CODE_BACKUP}"
            if [ "${RESTORE_DEPS}" = "true" ]; then
              echo "  - Wheel: ${TARGET_WHEEL_BACKUP}"
            else
              echo "  - Wheel: Skip (keep current dependencies)"
            fi
            echo ""
            
            # 3. Safety Backup (ÌòÑÏû¨ ÏÉÅÌÉú Î∞±ÏóÖ)
            SAFETY_BACKUP="${BACKUP_DIR}/safety_before_rollback_${TIMESTAMP}"
            echo "üõ°Ô∏è  Creating safety backup..."
            mkdir -p "${SAFETY_BACKUP}"
            
            if [ -d "${AI_APP_DIR}" ]; then
              cp -r "${AI_APP_DIR}" "${SAFETY_BACKUP}/"
              echo "‚úÖ Safety backup: ${SAFETY_BACKUP}"
            fi
            
            # 4. PM2 ÌîÑÎ°úÏÑ∏Ïä§ Ï†ïÎ¶¨
            echo ""
            echo "üßπ Stopping AI services..."
            sudo -u ubuntu pm2 list | grep -E 'ai-service|ai-serv' | awk '{print $2}' | while read -r pname; do
              if [ -n "$pname" ] && [ "$pname" != "name" ]; then
                sudo -u ubuntu pm2 stop "$pname" 2>/dev/null || true
                sudo -u ubuntu pm2 delete "$pname" 2>/dev/null || true
              fi
            done
            
            # 5. Ìè¨Ìä∏ Ï†ïÎ¶¨
            echo "üîå Cleaning port 8000..."
            sudo lsof -ti:8000 | xargs -r sudo kill -9 2>/dev/null || true
            sleep 1
            
            # 6. ÏΩîÎìú Î≥µÏõê
            echo ""
            echo "üìÅ Restoring code files..."
            sudo rm -rf "${AI_APP_DIR}"
            sudo cp -r "${TARGET_CODE_BACKUP}" "${AI_APP_DIR}"
            echo "‚úÖ Code restored"
            
            # 7. ÏùòÏ°¥ÏÑ± Î≥µÏõê (ÏÑ†ÌÉùÏ†Å)
            if [ "${RESTORE_DEPS}" = "true" ]; then
              echo ""
              echo "üì¶ Restoring dependencies..."
              
              WHEEL_FILE=$(ls "${TARGET_WHEEL_BACKUP}"/*.whl 2>/dev/null | head -n 1)
              if [ -n "$WHEEL_FILE" ]; then
                echo "Installing: $(basename $WHEEL_FILE)"
                "${AI_DIR}/venv/bin/pip" install "$WHEEL_FILE" --force-reinstall --no-cache-dir 2>&1 | tail -20
                echo "‚úÖ Dependencies restored"
              else
                echo "‚ö†Ô∏è  No wheel file in backup, using current dependencies"
              fi
            else
              echo ""
              echo "‚ö†Ô∏è  Skipping dependency restoration"
            fi
            
            # 8. Í∂åÌïú Î≥µÍµ¨
            sudo chown -R ubuntu:ubuntu "${AI_APP_DIR}" 2>/dev/null || true
            sudo chown -R ubuntu:ubuntu "${AI_DIR}" 2>/dev/null || true
            
            # 9. PM2Î°ú ÏÑúÎπÑÏä§ Ïû¨ÏãúÏûë
            echo ""
            echo "üöÄ Starting AI service..."
            sudo -u ubuntu pm2 start "${PM2_CONFIG}" --only ${APP_NAME} --env production || {
              echo "‚ùå Failed to start PM2"
              
              # Safety backup Î≥µÍµ¨ ÏãúÎèÑ
              if [ -d "${SAFETY_BACKUP}/ai_app" ]; then
                echo "üîô Restoring from safety backup..."
                sudo rm -rf "${AI_APP_DIR}"
                sudo cp -r "${SAFETY_BACKUP}/ai_app" "${AI_APP_DIR}"
                sudo chown -R ubuntu:ubuntu "${AI_APP_DIR}"
                sudo -u ubuntu pm2 start "${PM2_CONFIG}" --only ${APP_NAME} --env production || true
              fi
              exit 1
            }
            
            sleep 3
            
            # 10. PM2 ÏÉÅÌÉú ÌôïÏù∏
            sudo -u ubuntu pm2 describe ${APP_NAME} > /dev/null || {
              echo "‚ùå PM2 process not running"
              exit 1
            }
            echo "‚úÖ PM2 process started"
            
            # 11. Caddy Î¶¨Î°úÎìú
            echo ""
            echo "üîÑ Reloading Caddy..."
            systemctl is-active --quiet caddy && sudo systemctl reload caddy 2>/dev/null || true
            sleep 5
            
            # 12. Ìó¨Ïä§Ï≤¥ÌÅ¨ (ÏµúÎåÄ 10Ìöå)
            echo ""
            echo "üè• Health check..."
            RETRY_COUNT=0
            MAX_RETRIES=10
            
            for i in $(seq 1 $MAX_RETRIES); do
              if [ $i -eq 1 ]; then
                sleep 2
              else
                sleep $((2 + i / 2))
              fi
              
              HTTP_STATUS=$(timeout 10 curl -s -o /dev/null -w "%{http_code}" "${AI_HEALTH_URL}" 2>/dev/null || echo "000")
              
              if [ "${HTTP_STATUS}" = "200" ]; then
                echo "‚úÖ Rollback successful! (HTTP ${HTTP_STATUS})"
                echo ""
                
                # PM2 Ï†ÄÏû•
                sudo -u ubuntu pm2 save 2>/dev/null || true
                
                # ÏÑúÎπÑÏä§ ÏÉÅÌÉú
                echo "üìä Service Status:"
                sudo -u ubuntu pm2 status ${APP_NAME}
                echo ""
                
                # Safety backup Ï†ïÎ¶¨
                rm -rf "${SAFETY_BACKUP}"
                
                # Ïò§ÎûòÎêú Î∞±ÏóÖ Ï†ïÎ¶¨ (7Ïùº+)
                (find "${BACKUP_DIR}" -type d \( -name "code_*" -o -name "wheel_*" -o -name "safety_*" \) -mtime +7 -exec rm -rf {} + 2>/dev/null) &
                
                echo "============================================"
                echo "Rollback Complete: $(date)"
                echo "============================================"
                exit 0
              fi
              
              echo "‚ö†Ô∏è  Attempt $i/$MAX_RETRIES: HTTP ${HTTP_STATUS}"
              RETRY_COUNT=$i
            done
            
            # 13. Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìå® - Safety backup Î≥µÍµ¨
            echo ""
            echo "‚ùå Health check failed after ${RETRY_COUNT} attempts"
            echo ""
            echo "üîç PM2 Logs:"
            sudo -u ubuntu pm2 logs ${APP_NAME} --lines 30 --nostream || true
            
            echo ""
            echo "üîô Restoring from safety backup..."
            
            if [ -d "${SAFETY_BACKUP}/ai_app" ]; then
              sudo rm -rf "${AI_APP_DIR}"
              sudo cp -r "${SAFETY_BACKUP}/ai_app" "${AI_APP_DIR}"
              sudo chown -R ubuntu:ubuntu "${AI_APP_DIR}"
              
              sudo lsof -ti:8000 | xargs -r sudo kill -9 2>/dev/null || true
              sudo -u ubuntu pm2 list | grep -E 'ai-service|ai-serv' | awk '{print $2}' | while read -r pname; do
                [ -n "$pname" ] && [ "$pname" != "name" ] && sudo -u ubuntu pm2 delete "$pname" 2>/dev/null || true
              done
              
              sudo -u ubuntu pm2 start "${PM2_CONFIG}" --only ${APP_NAME} --env production
              sleep 5
              
              HTTP_STATUS=$(timeout 10 curl -s -o /dev/null -w "%{http_code}" "${AI_HEALTH_URL}" 2>/dev/null || echo "000")
              if [ "${HTTP_STATUS}" = "200" ]; then
                echo "‚úÖ Recovered using safety backup"
                sudo -u ubuntu pm2 save 2>/dev/null || true
                exit 0
              fi
            fi
            
            echo ""
            echo "‚ùå All recovery attempts failed"
            echo "üö® Manual intervention required"
            echo ""
            echo "Debug Info:"
            echo "  - Safety: ${SAFETY_BACKUP}"
            echo "  - Target: ${TARGET_CODE_BACKUP}"
            echo ""
            exit 1
          fi
          SCRIPT_END
          )
          
          # SSM Î™ÖÎ†π Ïã§Ìñâ
          SCRIPT_ENCODED=$(echo "$SCRIPT" | base64 -w 0)
          SSM_COMMAND="bash -c \"echo '$SCRIPT_ENCODED' | base64 -d | bash -s -- '$BASE_PATH' '$AI_DIR' '$AI_APP_DIR' '$BACKUP_DIR' '$PM2_CONFIG' '$MODE' '$BACKUP_ID' '$HEALTH_CHECK_URL' '$RESTORE_DEPS'\""
          
          PARAMETERS_JSON=$(jq -n --arg cmd "$SSM_COMMAND" '{commands: [$cmd]}')
          
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$EC2_INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters "$PARAMETERS_JSON" \
            --timeout-seconds 1200 \
            --region ap-northeast-2 \
            --query 'Command.CommandId' \
            --output text)
            
          [ -n "$COMMAND_ID" ] || exit 1
          
          echo "SSM Command ID: $COMMAND_ID"
          echo "Waiting for operation..."
          
          # Ïã§Ìñâ ÏÉÅÌÉú ÌôïÏù∏
          for i in {1..120}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$EC2_INSTANCE_ID" \
              --region ap-northeast-2 \
              --query 'Status' \
              --output text 2>/dev/null || echo "InProgress")
            
            if [ "$STATUS" = "Success" ]; then
              echo ""
              echo "=== Operation Output ==="
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$EC2_INSTANCE_ID" \
                --region ap-northeast-2 \
                --query 'StandardOutputContent' \
                --output text
              echo "success=true" >> $GITHUB_OUTPUT
              exit 0
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              echo ""
              echo "=== Operation Error ==="
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$EC2_INSTANCE_ID" \
                --region ap-northeast-2 \
                --query 'StandardErrorContent' \
                --output text
              echo "success=false" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            if [ $((i % 10)) -eq 0 ]; then
              echo "Progress: ${i}s elapsed..."
            fi
            sleep 3
          done
          
          echo "Timeout after 360s"
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1

      # Î°§Î∞± ÌõÑ SLO Í≤ÄÏ¶ù (restore Î™®ÎìúÏùº ÎïåÎßå)
      - name: Verify SLO After Rollback
        if: inputs.mode == 'restore' && steps.rollback.outputs.success == 'true'
        env:
          ENVIRONMENT: production
        run: |
          echo "üîç Î°§Î∞± ÌõÑ SLO Í≤ÄÏ¶ù (5Î∂Ñ ÎåÄÍ∏∞)"
          
          # Î©îÌä∏Î¶≠ ÏïàÏ†ïÌôî ÎåÄÍ∏∞
          sleep 300
          
          END_TIME=$(date -u +%Y-%m-%dT%H:%M:%S)
          START_TIME=$(date -u -d '10 minutes ago' +%Y-%m-%dT%H:%M:%S)
          
          echo "üìä Ï∏°Ï†ï Í∏∞Í∞Ñ: $START_TIME ~ $END_TIME"
          
          # Í∏∞Î≥∏ ÏÑ±Í≥µÎ•†Îßå ÌôïÏù∏
          DOC_SUCCESS=$(aws cloudwatch get-metric-statistics \
            --namespace "ReFit/AI" \
            --metric-name "DocumentAnalysisSuccessRate" \
            --dimensions Name=Environment,Value=$ENVIRONMENT \
            --start-time $START_TIME \
            --end-time $END_TIME \
            --period 600 \
            --statistics Average \
            --query 'Datapoints[0].Average' \
            --output text)
          
          if [ "$DOC_SUCCESS" != "None" ] && [ -n "$DOC_SUCCESS" ]; then
            echo "‚úÖ Î°§Î∞± ÌõÑ ÏÑúÎπÑÏä§ Ï†ïÏÉÅ (ÏÑ±Í≥µÎ•†: ${DOC_SUCCESS}%)"
          else
            echo "‚ÑπÔ∏è  ÏïÑÏßÅ Ï∂©Î∂ÑÌïú Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå"
          fi

      - name: Notify Discord
        if: always() && inputs.mode == 'restore'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          STATUS: ${{ steps.rollback.outputs.success }}
          BACKUP_ID: ${{ inputs.backup_id }}
          RESTORE_DEPS: ${{ inputs.restore_dependencies }}
          RUN_ID: ${{ github.run_id }}
        run: |
          if [ "$STATUS" = "true" ]; then
            COLOR=3066993
            EMOJI="üîÑ"
            TITLE="AI Î°§Î∞± ÏÑ±Í≥µ"
          else
            COLOR=15158332
            EMOJI="üö®"
            TITLE="AI Î°§Î∞± Ïã§Ìå®"
          fi

          BACKUP_TEXT="${BACKUP_ID:-ÏµúÏã† Î∞±ÏóÖ}"
          DEPS_TEXT="No"
          [ "$RESTORE_DEPS" = "true" ] && DEPS_TEXT="Yes"

          payload=$(cat <<EOF
          {
            "embeds": [{
              "title": "$EMOJI $TITLE",
              "color": $COLOR,
              "fields": [
                {"name": "ÏÑúÎπÑÏä§", "value": "Re-Fit AI", "inline": true},
                {"name": "Î∞±ÏóÖ ID", "value": "\`$BACKUP_TEXT\`", "inline": true},
                {"name": "ÏùòÏ°¥ÏÑ± Î≥µÏõê", "value": "$DEPS_TEXT", "inline": true},
                {"name": "ÏõåÌÅ¨ÌîåÎ°úÏö∞", "value": "[ÏÉÅÏÑ∏ Î≥¥Í∏∞](https://github.com/${{ github.repository }}/actions/runs/$RUN_ID)", "inline": false}
              ],
              "footer": { "text": "Re-Fit AI Rollback" },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )

          curl -H "Content-Type: application/json" -X POST -d "$payload" "$DISCORD_WEBHOOK"