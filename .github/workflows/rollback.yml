name: AI Service Rollback (Docker)

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Operation Mode'
        required: true
        type: choice
        options:
          - list
          - restore
        default: 'list'
      image_tag:
        description: 'Docker image tag to restore (e.g., main-abc1234). Required for restore.'
        required: false
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ========== MODE: list - ECR ì´ë¯¸ì§€ íƒœê·¸ ëª©ë¡ ì¡°íšŒ ==========
      - name: List available image tags (ECR)
        if: inputs.mode == 'list'
        run: |
          echo "============================================"
          echo "Re-Fit AI Rollback (Docker) - ì´ë¯¸ì§€ ëª©ë¡"
          echo "============================================"
          REPO="${{ secrets.ECR_REPOSITORY_AI }}"
          if [ -z "$REPO" ]; then
            echo "âŒ ECR_REPOSITORY_AI not set"
            exit 1
          fi
          echo ""
          echo "ğŸ“‚ ECR ì´ë¯¸ì§€ íƒœê·¸ (main-*, ìµœê·¼ í‘¸ì‹œìˆœ):"
          echo ""
          aws ecr describe-images \
            --repository-name "$REPO" \
            --query 'sort_by(imageDetails,& imagePushedAt)' \
            --output json --region ap-northeast-2 2>/dev/null | \
          python3 -c "
          import json,sys
          d=json.load(sys.stdin)
          seen=set()
          out=[]
          for img in reversed(d.get('imageDetails',[])):
            pushed=img.get('imagePushedAt','')[:19].replace('T',' ')
            for t in (img.get('imageTags') or []):
              if t.startswith('main-') and t not in seen:
                seen.add(t); out.append((t,pushed))
          for t,p in out[:20]:
            print(f'  â€¢ {t}  (pushed: {p})')
          " 2>/dev/null || echo "  (ì´ë¯¸ì§€ ì—†ìŒ ë˜ëŠ” ê¶Œí•œ í™•ì¸ í•„ìš”)"
          echo ""
          echo "ğŸ’¡ Restore ë°©ë²•: mode=restore, image_tag=main-<sha7> (ì˜ˆ: main-abc1234)"

      # ========== MODE: restore - Docker ì´ë¯¸ì§€ë¡œ ë¡¤ë°± ==========
      - name: Restore to Docker image via SSM
        if: inputs.mode == 'restore'
        id: rollback
        env:
          EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID_V2 }}
          HEALTH_CHECK_URL: ${{ secrets.HEALTH_CHECK_URL_V2 }}
          PROD_COMPOSE_DIR: ${{ secrets.PROD_COMPOSE_DIR_V2 }}
          AI_ENV_FILE_PROD: ${{ secrets.AI_ENV_FILE_PROD_V2 }}
          ECR_REPOSITORY_AI: ${{ secrets.ECR_REPOSITORY_AI }}
          IMAGE_TAG: ${{ inputs.image_tag }}
        run: |
          set -euo pipefail
          if [ -z "$IMAGE_TAG" ]; then
            echo "âŒ restore ëª¨ë“œì—ì„œëŠ” image_tag ì…ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤ (ì˜ˆ: main-abc1234)"
            exit 1
          fi
          ECR_REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          COMPOSE_DIR="${PROD_COMPOSE_DIR}"
          AI_HEALTH_URL="${HEALTH_CHECK_URL%/health}/api/ai/health"

          DEPLOY_SCRIPT=$(cat <<'SCRIPT_END'
          set -euo pipefail
          export PATH="/usr/local/bin:/usr/bin:/bin:$PATH"
          COMPOSE_DIR="$1"
          IMAGE_TAG="$2"
          HEALTH_CHECK_URL="$3"
          AI_ENV_FILE="$4"
          ECR_REGISTRY="$5"
          ECR_REPO="$6"
          FULL_IMAGE="${ECR_REGISTRY}/${ECR_REPO}:${IMAGE_TAG}"

          echo "============================================"
          echo "Re-Fit AI ë¡¤ë°± (Docker): $(date)"
          echo "  Image: ${FULL_IMAGE}"
          echo "============================================"

          if [ ! -d "$COMPOSE_DIR" ]; then
            echo "âŒ Compose directory not found: $COMPOSE_DIR"
            exit 1
          fi

          aws ecr get-login-password --region ap-northeast-2 | \
            docker login --username AWS --password-stdin "$(echo ${FULL_IMAGE} | cut -d/ -f1)"

          cd "$COMPOSE_DIR"

          if [ -n "$AI_ENV_FILE" ]; then
            echo "$AI_ENV_FILE" > .env.ai
            chmod 644 .env.ai
          fi

          if grep -q '^AI_TAG=' .env 2>/dev/null; then
            sed -i "s|^AI_TAG=.*|AI_TAG=${IMAGE_TAG}|" .env
          else
            echo "AI_TAG=${IMAGE_TAG}" >> .env
          fi
          echo "ğŸ·ï¸ AI_TAG=${IMAGE_TAG}"

          echo "ğŸ“¥ Pulling image..."
          docker compose pull ai || docker compose pull 2>/dev/null || true

          echo "ğŸ”„ Restarting ai service..."
          docker compose up -d ai || docker compose up -d 2>/dev/null || true

          docker image prune -f 2>/dev/null || true
          docker image prune -a -f 2>/dev/null || true
          echo "ì„œë¹„ìŠ¤ ì´ˆê¸°í™” ëŒ€ê¸° (30ì´ˆ)..."
          sleep 30

          systemctl is-active --quiet caddy && sudo systemctl reload caddy 2>/dev/null || true
          sleep 2

          if [ -z "$HEALTH_CHECK_URL" ]; then
            echo "âš ï¸ HEALTH_CHECK_URL ë¯¸ì„¤ì • - í—¬ìŠ¤ì²´í¬ ê±´ë„ˆëœ€"
            exit 0
          fi

          for i in {1..15}; do
            HTTP_STATUS=$(timeout 10 curl -s -o /dev/null -w "%{http_code}" "$HEALTH_CHECK_URL" 2>/dev/null || echo "000")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… ë¡¤ë°± ì„±ê³µ! (HTTP $HTTP_STATUS)"
              exit 0
            fi
            echo "âš ï¸ ì‹œë„ $i/15: HTTP $HTTP_STATUS"
            [ $i -lt 15 ] && sleep 5
          done

          echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
          exit 1
          SCRIPT_END
          )

          SCRIPT_ENCODED=$(echo "$DEPLOY_SCRIPT" | base64 -w 0)
          SSM_COMMAND="bash -c \"echo '$SCRIPT_ENCODED' | base64 -d | bash -s -- '$COMPOSE_DIR' '$IMAGE_TAG' '$AI_HEALTH_URL' '$AI_ENV_FILE_PROD' '$ECR_REGISTRY' '$ECR_REPOSITORY_AI'\""
          PARAMETERS_JSON=$(jq -n --arg cmd "$SSM_COMMAND" '{commands: [$cmd]}')

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$EC2_INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters "$PARAMETERS_JSON" \
            --timeout-seconds 1800 \
            --region ap-northeast-2 \
            --query 'Command.CommandId' \
            --output text)

          [ -n "$COMMAND_ID" ] || exit 1
          echo "SSM Command ID: $COMMAND_ID"

          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$EC2_INSTANCE_ID" \
              --region ap-northeast-2 \
              --query 'Status' \
              --output text 2>/dev/null || echo "InProgress")

            if [ "$STATUS" = "Success" ]; then
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$EC2_INSTANCE_ID" \
                --region ap-northeast-2 \
                --query 'StandardOutputContent' --output text
              echo "success=true" >> $GITHUB_OUTPUT
              exit 0
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" --instance-id "$EC2_INSTANCE_ID" --region ap-northeast-2 \
                --query 'StandardOutputContent' --output text
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" --instance-id "$EC2_INSTANCE_ID" --region ap-northeast-2 \
                --query 'StandardErrorContent' --output text
              echo "success=false" >> $GITHUB_OUTPUT
              exit 1
            fi
            [ $i -lt 60 ] && sleep 5
          done
          echo "SSM timeout"
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1

      # ë¡¤ë°± í›„ SLO ê²€ì¦ (restore ëª¨ë“œì¼ ë•Œë§Œ)
      - name: Verify SLO After Rollback
        if: inputs.mode == 'restore' && steps.rollback.outputs.success == 'true'
        env:
          ENVIRONMENT: production
        run: |
          echo "ğŸ” ë¡¤ë°± í›„ SLO ê²€ì¦ (5ë¶„ ëŒ€ê¸°)"
          sleep 300
          END_TIME=$(date -u +%Y-%m-%dT%H:%M:%S)
          START_TIME=$(date -u -d '10 minutes ago' +%Y-%m-%dT%H:%M:%S 2>/dev/null || date -u -v-10M +%Y-%m-%dT%H:%M:%S)
          echo "ğŸ“Š ì¸¡ì • ê¸°ê°„: $START_TIME ~ $END_TIME"
          DOC_SUCCESS=$(aws cloudwatch get-metric-statistics \
            --namespace "ReFit/AI" \
            --metric-name "DocumentAnalysisSuccessRate" \
            --dimensions Name=Environment,Value=$ENVIRONMENT \
            --start-time $START_TIME \
            --end-time $END_TIME \
            --period 600 \
            --statistics Average \
            --query 'Datapoints[0].Average' \
            --output text)
          if [ "$DOC_SUCCESS" != "None" ] && [ -n "$DOC_SUCCESS" ]; then
            echo "âœ… ë¡¤ë°± í›„ ì„œë¹„ìŠ¤ ì •ìƒ (ì„±ê³µë¥ : ${DOC_SUCCESS}%)"
          else
            echo "â„¹ï¸  ì•„ì§ ì¶©ë¶„í•œ ë°ì´í„° ì—†ìŒ"
          fi

      - name: Notify Discord
        if: always() && inputs.mode == 'restore'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          STATUS: ${{ steps.rollback.outputs.success }}
          IMAGE_TAG: ${{ inputs.image_tag }}
          RUN_ID: ${{ github.run_id }}
        run: |
          [ -z "$DISCORD_WEBHOOK" ] && exit 0
          if [ "$STATUS" = "true" ]; then
            COLOR=3066993
            EMOJI="ğŸ”„"
            TITLE="AI ë¡¤ë°± ì„±ê³µ (Docker)"
          else
            COLOR=15158332
            EMOJI="ğŸš¨"
            TITLE="AI ë¡¤ë°± ì‹¤íŒ¨ (Docker)"
          fi
          payload=$(cat <<EOF
          {
            "embeds": [{
              "title": "$EMOJI $TITLE",
              "color": $COLOR,
              "fields": [
                {"name": "ì„œë¹„ìŠ¤", "value": "Re-Fit AI", "inline": true},
                {"name": "ì´ë¯¸ì§€ íƒœê·¸", "value": "\`$IMAGE_TAG\`", "inline": true},
                {"name": "ì›Œí¬í”Œë¡œìš°", "value": "[ìƒì„¸ ë³´ê¸°](https://github.com/${{ github.repository }}/actions/runs/$RUN_ID)", "inline": false}
              ],
              "footer": { "text": "Re-Fit AI Rollback (Docker)" },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )
          curl -s -H "Content-Type: application/json" -X POST -d "$payload" "$DISCORD_WEBHOOK"
