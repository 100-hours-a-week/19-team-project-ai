name: Re-Fit AI CI

on:
  pull_request:
    # feature -> develop ÎòêÎäî develop -> main PR Ïãú Ïã§Ìñâ
    branches: [develop, main]
    types: [opened, synchronize, reopened]
    paths-ignore:
      - '.github/workflows/**'
  push:
    # develop ÎòêÎäî mainÏúºÎ°ú push(Î®∏ÏßÄ Ìè¨Ìï®)Îê† Îïå Ïã§Ìñâ
    branches: [develop, main]
    paths-ignore:
      - '.github/workflows/**'
  workflow_dispatch:
    # ÏàòÎèô Ïã§Ìñâ Ïãú ÏûëÏóÖÏùÑ ÏÑ†ÌÉùÌï† Ïàò ÏûàÎäî ÎîîÏä§Ìå®Ï≤ò Íµ¨ÏÑ±
    inputs:
      job_to_run:
        description: 'Which job to run'
        required: true
        type: choice
        options:
          - lint-and-test
          - integration
          - release-dev
          - release-prod
          - release-prod-v2
          - all

permissions:
  contents: write  # git-auto-commit-actionÏù¥ ÌååÏùºÏùÑ Ïª§Î∞ãÌïòÍ≥† Ìë∏ÏãúÌï† Ïàò ÏûàÎèÑÎ°ù ÌóàÏö©

env:
  PYTHON_VERSION: '3.11'
  WORKING_DIRECTORY: 'ai_app'

jobs:

  # 1. PR Í≤ÄÏ¶ù Îã®Í≥Ñ (Lint + Test + Build Check)
  lint-and-test:
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job_to_run == 'lint-and-test' || github.event.inputs.job_to_run == 'all'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      # requirements.txtÏôÄ pyproject.toml ÏûêÎèô ÎèôÍ∏∞Ìôî
      - name: Auto-sync requirements.txt to pyproject.toml
        id: sync-deps
        run: |
          python scripts/sync-to-pyproject.py
          
          # Git diff ÌôïÏù∏
          if git diff --quiet pyproject.toml; then
            echo "‚úÖ ÎèôÍ∏∞Ìôî ÏôÑÎ£å (Î≥ÄÍ≤Ω ÏóÜÏùå)"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "üîÑ pyproject.toml ÏóÖÎç∞Ïù¥Ìä∏Îê®!"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: |
            pyproject.toml
            uv.lock
      
      - name: Install Dependencies
        run: uv sync --locked --extra dev
      
      # Î¶∞Ìä∏ Î∞è ÏûêÎèô ÏàòÏ†ï Ï†ÅÏö©
      - name: Run Lint and Format (Ruff)
        id: ruff-fix
        run: |
          cd ${{ env.WORKING_DIRECTORY }}
          uv run ruff check . --fix
          uv run ruff format .
          uv run ruff check .
          uv run ruff format --check .
          
          # Î≥ÄÍ≤ΩÏÇ¨Ìï≠ ÌôïÏù∏
          cd ..
          if git diff --quiet; then
            echo "‚úÖ Î¶∞Ìä∏ Î∞è Ìè¨Îß∑ÌåÖ ÌÜµÍ≥º (Î≥ÄÍ≤Ω ÏóÜÏùå)"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "üîÑ Î¶∞Ìä∏/Ìè¨Îß∑ÌåÖ ÏûêÎèô ÏàòÏ†ïÎê®!"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
      
      # Î≥ÄÍ≤ΩÏÇ¨Ìï≠(pyproject.toml ÎèôÍ∏∞Ìôî + Ruff ÏûêÎèô ÏàòÏ†ï)Ïù¥ ÏûàÏúºÎ©¥ ÏûêÎèô Ïª§Î∞ã (PRÏùº ÎïåÎßå)
      - name: Auto-commit changes
        if: (steps.sync-deps.outputs.changed == 'true' || steps.ruff-fix.outputs.changed == 'true') && github.event_name == 'pull_request'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: Auto-sync dependencies and lint fixes"
          file_pattern: "."
          branch: ${{ github.event.pull_request.head.ref }}
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
      
      # [Type Check] MyPyÎ•º ÏÇ¨Ïö©Ìïú Ï†ïÏ†Å ÌÉÄÏûÖ Î∂ÑÏÑù
      - name: Static Type Check (MyPy)
        run: uv run mypy . --ignore-missing-imports || true
      
      # [Security Scan] FrontendÏùò auditÍ≥º ÎåÄÏùëÎêòÎäî Î≥¥Ïïà Í≤ÄÏÇ¨ Ï∂îÍ∞Ä
      - name: Security Scan (Bandit)
        run: uv run bandit -r ${{ env.WORKING_DIRECTORY }} -x tests/
      
      # [Unit Tests] Îã®ÏúÑ ÌÖåÏä§Ìä∏ ÏàòÌñâ
      - name: Run Unit Tests
        run: |
          if [ -d "tests/unit" ]; then
            uv run pytest tests/unit -v --cov=${{ env.WORKING_DIRECTORY }}
          else
            echo "No unit tests found"
          fi

      # [Build Check] Î®∏ÏßÄ Ï†Ñ ÎπåÎìú Í∞ÄÎä• Ïó¨Î∂Ä ÌôïÏù∏ Îã®Í≥Ñ Ï∂îÍ∞Ä
      - name: Build Check
        run: uv run python -m build --wheel
        env:
          NODE_ENV: production # Ïª®ÌÖçÏä§Ìä∏ Ïú†ÏßÄÎ•º ÏúÑÌïú ÏÑ§Ï†ï
      
      # Í∏∞Ï°¥ Application Start Ï≤¥ÌÅ¨ Ïú†ÏßÄ
      - name: Verify Application Starts
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)/${{ env.WORKING_DIRECTORY }}
          timeout 10s uv run python -c "from api.main import app; print('Application loaded successfully')" || true

  # ===========================================
  # 2. ÌÜµÌï© Í≤ÄÏ¶ù Îã®Í≥Ñ (Integration Tests)
  # ===========================================
  integration:
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/develop') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job_to_run == 'integration' || github.event.inputs.job_to_run == 'all'))
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: |
            pyproject.toml
            uv.lock
      
      # [Integration] develop Î∏åÎûúÏπò Ìë∏Ïãú ÏãúÏóêÎßå ÌÜµÌï© ÌÖåÏä§Ìä∏ Ïã§Ìñâ
      - name: Install Dependencies
        run: uv sync --locked --extra dev
      
      - name: Integration Test
        run: |
          if [ -d "tests/integration" ]; then
            uv run pytest tests/integration -v
          else
            echo "‚ö†Ô∏è Integration tests not yet implemented"
          fi

  # ===========================================
  # 3. Í∞úÎ∞ú ÌôòÍ≤Ω Î¶¥Î¶¨Ï¶à (develop Î∏åÎûúÏπò - Docker Í∏∞Î∞ò)
  # ===========================================
  release-dev:
    needs: [integration]
    if: |
      always() &&
      needs.integration.result != 'failure' &&
      (
        (github.event_name == 'push' && github.ref == 'refs/heads/develop') ||
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.job_to_run == 'release-dev' || github.event.inputs.job_to_run == 'all'))
      )
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate Image Metadata
        id: meta
        run: |
          SHA_SHORT="${GITHUB_SHA::7}"
          IMAGE_TAG="develop-${SHA_SHORT}"
          FULL_IMAGE="${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY_AI }}:${IMAGE_TAG}"
          LATEST_IMAGE="${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY_AI }}:develop-latest"

          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "full_image=${FULL_IMAGE}" >> $GITHUB_OUTPUT
          echo "latest_image=${LATEST_IMAGE}" >> $GITHUB_OUTPUT
          echo "sha_short=${SHA_SHORT}" >> $GITHUB_OUTPUT
          echo "üê≥ Docker Image: ${FULL_IMAGE}"

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ steps.meta.outputs.full_image }}
            ${{ steps.meta.outputs.latest_image }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/arm64

      - name: Trigger CD-Dev Workflow
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'cd-dev.yml',
              ref: 'develop',
              inputs: {
                image_tag: '${{ steps.meta.outputs.image_tag }}',
                sha: '${{ github.sha }}',
                run_id: '${{ github.run_id }}'
              }
            });
            console.log('‚úÖ CD-Dev workflow triggered successfully');

  # ===========================================
  # 4. ÌîÑÎ°úÎçïÏÖò Î¶¥Î¶¨Ï¶à V1 (main push Ïãú ÏûêÎèô, Wheel + cd-prod)
  # ===========================================
  release-prod:
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job_to_run == 'release-prod' || github.event.inputs.job_to_run == 'all'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: |
            pyproject.toml
            uv.lock
      
      - name: Get Version
        id: version
        run: |
          VERSION=$(grep -E "^version\s*=" pyproject.toml | sed 's/.*"\(.*\)"/\1/' || echo "0.1.0")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"
      
      - name: Install dependencies
        run: uv sync --locked --extra dev
      
      - name: Run Full Tests
        run: |
          if [ -d "tests" ] || [ -d "${{ env.WORKING_DIRECTORY }}/tests" ]; then
            if [ -d "tests" ]; then
              uv run pytest tests/ -v || echo "Tests failed but continuing"
            else
              uv run pytest ${{ env.WORKING_DIRECTORY }}/tests -v || echo "Tests failed but continuing"
            fi
          else
            echo "No tests found, skipping"
          fi
      
      - name: Create Release Package
        run: |
          uv run python -m build --wheel
      
      - name: Verify Build Output
        run: |
          echo "Current directory: $(pwd)"
          if [ -d "dist" ] && [ -n "$(ls -A dist/*.whl 2>/dev/null)" ]; then
            echo "Wheel package created"
            ls -lh dist/
            echo "Absolute path: $(pwd)/dist"
          else
            echo "Wheel package not found"
            exit 1
          fi
      
      - name: Archive Build Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ai-wheel-${{ github.sha }}
          path: dist/*.whl
          retention-days: 7
      
      - name: Archive Deployment Files
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ai-deploy-files-${{ github.sha }}
          path: |
            ai_app/**/*.py
            pyproject.toml
            README.md
            scripts/verify-slo-cloudwatch.sh
          retention-days: 7
      
      - name: Create Release Tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          TAG_NAME="v${{ steps.version.outputs.version }}-${GITHUB_SHA::7}"
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME" || true
          git push origin "$TAG_NAME" || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      
      - name: Trigger CD-Prod Workflow (V1)
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'cd-prod.yml',
              ref: 'main',
              inputs: {
                run_id: '${{ github.run_id }}',
                sha: '${{ github.sha }}',
                branch: 'main'
              }
            });
            console.log('‚úÖ CD-Prod (V1) workflow triggered successfully');

  # ===========================================
  # 5. ÌîÑÎ°úÎçïÏÖò Î¶¥Î¶¨Ï¶à V2 (ÏàòÎèô ÎîîÏä§Ìå®Ïπò Ï†ÑÏö© - Docker + cd-prod-v2)
  # ===========================================
  release-prod-v2:
    if: |
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.job_to_run == 'release-prod-v2' || github.event.inputs.job_to_run == 'all')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: |
            pyproject.toml
            uv.lock
      
      - name: Install dependencies
        run: uv sync --locked --extra dev
      
      - name: Run Full Tests
        run: |
          if [ -d "tests" ] || [ -d "${{ env.WORKING_DIRECTORY }}/tests" ]; then
            if [ -d "tests" ]; then
              uv run pytest tests/ -v || echo "Tests failed but continuing"
            else
              uv run pytest ${{ env.WORKING_DIRECTORY }}/tests -v || echo "Tests failed but continuing"
            fi
          else
            echo "No tests found, skipping"
          fi
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Docker image tag (V2)
        id: docker-meta
        run: |
          SHA_SHORT="${GITHUB_SHA::7}"
          IMAGE_TAG="main-${SHA_SHORT}"
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "sha_short=${SHA_SHORT}" >> $GITHUB_OUTPUT
          echo "üê≥ Docker image tag (V2): ${IMAGE_TAG}"
      
      - name: Build and Push Docker Image (V2)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY_AI }}:${{ steps.docker-meta.outputs.image_tag }}
            ${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY_AI }}:main-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/arm64
      
      - name: Trigger CD-Prod-V2 Workflow
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'cd-prod-v2.yml',
              ref: 'main',
              inputs: {
                use_existing_image: 'true'
              }
            });
            console.log('‚úÖ CD-Prod-V2 workflow triggered (use_existing_image=true)');