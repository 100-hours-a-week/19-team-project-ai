name: Re-Fit AI CD

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'CI workflow run ID (ìë™ ì…ë ¥ ë˜ëŠ” ì§ì ‘ ì…ë ¥)'
        required: false
        type: string
      sha:
        description: 'Commit SHA (ìë™ ì…ë ¥ ë˜ëŠ” ì§ì ‘ ì…ë ¥)'
        required: false
        type: string
      branch:
        description: 'Branch name'
        required: true
        type: choice
        default: 'develop'
        options:
          - develop
          - main
      use_latest_artifact:
        description: 'run_id/shaë¥¼ ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ ì„ íƒí•œ ë¸Œëœì¹˜ì˜ ìµœì‹  ì•„í‹°íŒ©íŠ¸ ì‚¬ìš©'
        required: true
        type: boolean
        default: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ==========================================
  # 1ë‹¨ê³„: ë°°í¬ ì „ ê²€ì¦ (Pre-deployment Validation)
  # ==========================================
  pre-deployment-check:
    runs-on: ubuntu-latest
    environment: ${{ inputs.branch == 'main' && 'production' || 'development' }}
    outputs:
      can_deploy: ${{ steps.error_budget_check.outputs.can_deploy }}
      error_budget_status: ${{ steps.error_budget_check.outputs.status }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      # Error Budget í™•ì¸ - ë°°í¬ ê°€ëŠ¥ ì—¬ë¶€ ê²°ì •
      - name: Check Error Budget Before Deployment
        id: error_budget_check
        env:
          ENVIRONMENT: ${{ inputs.branch == 'main' && 'production' || 'development' }}
        run: |
          echo "ğŸ” Error Budget í™•ì¸ ì¤‘..."
          
          # CloudWatchì—ì„œ ìµœê·¼ 1ì‹œê°„ ì„±ê³µë¥  ì¡°íšŒ
          END_TIME=$(date -u +%Y-%m-%dT%H:%M:%S)
          START_TIME=$(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%S)
          
          # ë¬¸ì„œ ë¶„ì„ ì„±ê³µë¥ 
          DOC_SUCCESS_RATE=$(aws cloudwatch get-metric-statistics \
            --namespace "ReFit/AI" \
            --metric-name "DocumentAnalysisSuccessRate" \
            --dimensions Name=Environment,Value=$ENVIRONMENT \
            --start-time $START_TIME \
            --end-time $END_TIME \
            --period 3600 \
            --statistics Average \
            --query 'Datapoints[0].Average' \
            --output text)
          
          # ì¶”ì²œ ì„±ê³µë¥ 
          RECO_SUCCESS_RATE=$(aws cloudwatch get-metric-statistics \
            --namespace "ReFit/AI" \
            --metric-name "RecommendationSuccessRate" \
            --dimensions Name=Environment,Value=$ENVIRONMENT \
            --start-time $START_TIME \
            --end-time $END_TIME \
            --period 3600 \
            --statistics Average \
            --query 'Datapoints[0].Average' \
            --output text)
          
          
          # ë°ì´í„°ê°€ ì—†ìœ¼ë©´ 100ìœ¼ë¡œ ê°„ì£¼ (ì‹ ê·œ í™˜ê²½)
          DOC_SUCCESS_RATE=${DOC_SUCCESS_RATE:-100}
          RECO_SUCCESS_RATE=${RECO_SUCCESS_RATE:-100}
          REPORT_SUCCESS_RATE=${REPORT_SUCCESS_RATE:-100}
          
          echo "ğŸ“Š í˜„ì¬ ì„±ê³µë¥ :"
          echo "  - ë¬¸ì„œ ë¶„ì„: ${DOC_SUCCESS_RATE}% (ëª©í‘œ: 93%)"
          echo "  - ì¶”ì²œ: ${RECO_SUCCESS_RATE}% (ëª©í‘œ: 97%)"
          echo "  - ë¦¬í¬íŠ¸: ${REPORT_SUCCESS_RATE}% (ëª©í‘œ: 93%)"
          
          # Error Budget ê³„ì‚° (SLO ë¬¸ì„œ ì°¸ê³ )
          # Error Budget = (100 - ì‹¤ì œ ì„±ê³µë¥ ) / (100 - ëª©í‘œ ì„±ê³µë¥ ) * 100
          
          DOC_ERROR_BUDGET=$(awk "BEGIN {printf \"%.2f\", (100 - $DOC_SUCCESS_RATE) / (100 - 93) * 100}")
          RECO_ERROR_BUDGET=$(awk "BEGIN {printf \"%.2f\", (100 - $RECO_SUCCESS_RATE) / (100 - 97) * 100}")
          REPORT_ERROR_BUDGET=$(awk "BEGIN {printf \"%.2f\", (100 - $REPORT_SUCCESS_RATE) / (100 - 98) * 100}")
          
          echo ""
          echo "ğŸ’° Error Budget ì†Œì§„ìœ¨:"
          echo "  - ë¬¸ì„œ ë¶„ì„: ${DOC_ERROR_BUDGET}%"
          echo "  - ì¶”ì²œ: ${RECO_ERROR_BUDGET}%"
          echo "  - ë¦¬í¬íŠ¸: ${REPORT_ERROR_BUDGET}%"
          
          # ë°°í¬ ê°€ëŠ¥ ì—¬ë¶€ íŒë‹¨ (Error Budget < 50% ê¶Œì¥, < 75% í—ˆìš©)
          CAN_DEPLOY="true"
          STATUS="healthy"
          
          for budget in $DOC_ERROR_BUDGET $RECO_ERROR_BUDGET $REPORT_ERROR_BUDGET; do
            # ìˆ«ì ë¹„êµ (ì†Œìˆ˜ì  ì²˜ë¦¬)
            if awk "BEGIN {exit !($budget >= 75)}"; then
              CAN_DEPLOY="warning"
              STATUS="degraded"
              echo "âš ï¸  ê²½ê³ : Error Budgetì´ 75% ì´ìƒ ì†Œì§„ë¨ ($budget%)"
            elif awk "BEGIN {exit !($budget >= 100)}"; then
              CAN_DEPLOY="false"
              STATUS="exceeded"
              echo "ğŸš¨ Error Budget ì´ˆê³¼! ë°°í¬ ì¤‘ë‹¨ ê¶Œì¥ ($budget%)"
            fi
          done
          
          echo ""
          echo "can_deploy=$CAN_DEPLOY" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          
          if [ "$CAN_DEPLOY" = "false" ]; then
            echo "âŒ Error Budgetì´ ì´ˆê³¼ë˜ì–´ ë°°í¬ë¥¼ ê¶Œì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            echo "   ì•ˆì •í™” ì‘ì—… í›„ ì¬ì‹œë„í•˜ê±°ë‚˜, ê°•ì œ ë°°í¬ë¥¼ ì›í•˜ë©´ ìˆ˜ë™ìœ¼ë¡œ ì§„í–‰í•˜ì„¸ìš”."
            exit 1
          elif [ "$CAN_DEPLOY" = "warning" ]; then
            echo "âš ï¸  Error Budget ê²½ê³  ìƒíƒœì´ì§€ë§Œ ë°°í¬ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤."
            echo "   ë°°í¬ í›„ ë©´ë°€í•œ ëª¨ë‹ˆí„°ë§ì´ í•„ìš”í•©ë‹ˆë‹¤."
          else
            echo "âœ… Error Budget ì •ìƒ - ë°°í¬ ì§„í–‰ ê°€ëŠ¥"
          fi

      # í˜„ì¬ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
      - name: Check Current Service Health
        continue-on-error: true
        env:
          HEALTH_CHECK_URL: ${{ secrets.HEALTH_CHECK_URL }}
        run: |
          echo "ğŸ¥ í˜„ì¬ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸..."
          
          AI_HEALTH_URL="${HEALTH_CHECK_URL%/health}/api/ai/health"
          
          HTTP_STATUS=$(timeout 10 curl -s -o /dev/null -w "%{http_code}" "$AI_HEALTH_URL" 2>/dev/null || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… í˜„ì¬ ì„œë¹„ìŠ¤ ì •ìƒ ì‘ë™ ì¤‘ (HTTP $HTTP_STATUS)"
          else
            echo "âš ï¸  í˜„ì¬ ì„œë¹„ìŠ¤ ìƒíƒœ ë¶ˆëŸ‰ (HTTP $HTTP_STATUS)"
            echo "   ë°°í¬ë¡œ ìƒí™©ì´ ê°œì„ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          fi

  # ==========================================
  # 2ë‹¨ê³„: ì•„í‹°íŒ©íŠ¸ ì¤€ë¹„ ë° ë°°í¬
  # ==========================================
  deploy:
    runs-on: ubuntu-latest
    needs: pre-deployment-check
    environment: ${{ inputs.branch == 'main' && 'production' || 'development' }}
    outputs:
      deployment_success: ${{ steps.deploy.outputs.success }}
      deployment_sha: ${{ steps.deploy-vars.outputs.sha }}
    steps:
      - name: Find Latest Artifact (if needed)
        if: inputs.use_latest_artifact == true && (inputs.run_id == '' || inputs.sha == '')
        id: find-artifact
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const branch = '${{ inputs.branch }}';
            console.log(`Finding latest artifact for branch: ${branch}`);

            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci.yml',
              branch: branch,
              status: 'success',
              per_page: 10
            });

            if (runs.data.workflow_runs.length === 0) {
              core.setFailed(`No successful CI runs found for branch: ${branch}`);
              return;
            }

            for (const run of runs.data.workflow_runs) {
              const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: run.id
              });

              const buildArtifact = artifacts.data.artifacts.find(
                a => a.name.startsWith('ai-wheel-')
              );

              if (buildArtifact) {
                const sha = run.head_sha;
                console.log(`Found artifact from run #${run.run_number}`);
                console.log(`   Run ID: ${run.id}`);
                console.log(`   SHA: ${sha}`);
                console.log(`   Created: ${run.created_at}`);

                core.setOutput('run_id', run.id.toString());
                core.setOutput('sha', sha);
                core.setOutput('run_number', run.run_number.toString());
                return;
              }
            }

            core.setFailed(`No artifacts found in recent CI runs for branch: ${branch}`);

      - name: Set Deployment Variables
        id: deploy-vars
        run: |
          if [ "${{ inputs.use_latest_artifact }}" == "true" ] && [ -z "${{ inputs.run_id }}" ]; then
            echo "run_id=${{ steps.find-artifact.outputs.run_id }}" >> $GITHUB_OUTPUT
            echo "sha=${{ steps.find-artifact.outputs.sha }}" >> $GITHUB_OUTPUT
            echo "Using latest artifact from run #${{ steps.find-artifact.outputs.run_number }}"
          else
            echo "run_id=${{ inputs.run_id }}" >> $GITHUB_OUTPUT
            echo "sha=${{ inputs.sha }}" >> $GITHUB_OUTPUT
            echo "Using manually specified artifact"
          fi

      - name: Download Wheel Package
        uses: actions/download-artifact@v4
        with:
          name: ai-wheel-${{ steps.deploy-vars.outputs.sha }}
          path: build-output/dist
          github-token: ${{ secrets.PAT }}
          run-id: ${{ steps.deploy-vars.outputs.run_id }}

      - name: Download Deployment Files
        uses: actions/download-artifact@v4
        with:
          name: ai-deploy-files-${{ steps.deploy-vars.outputs.sha }}
          path: build-output
          github-token: ${{ secrets.PAT }}
          run-id: ${{ steps.deploy-vars.outputs.run_id }}

      - name: Verify Downloaded Files
        run: |
          echo "=== Verifying downloaded files ==="
          ls -la build-output/
          
          if [ -d "build-output/dist" ] && [ -n "$(ls -A build-output/dist/*.whl 2>/dev/null)" ]; then
            echo "âœ… Wheel package found"
            ls -lh build-output/dist/
          else
            echo "âŒ Wheel package not found"
            exit 1
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Upload Wheel Package to S3
        id: s3_upload
        run: |
          set -euo pipefail
          COMMIT_SHA=${{ steps.deploy-vars.outputs.sha }}
          S3_KEY="artifacts/ai/${COMMIT_SHA}/$(basename build-output/dist/*.whl)"
          
          echo "Uploading wheel package to s3://${{ secrets.S3_ARTIFACTS_BUCKET }}/$S3_KEY"
          aws s3 cp build-output/dist/*.whl s3://${{ secrets.S3_ARTIFACTS_BUCKET }}/$S3_KEY
          
          echo "s3_key=$S3_KEY" >> $GITHUB_OUTPUT

      - name: Deploy via SSM
        id: deploy
        env:
          SERVER_BASE_PATH: ${{ secrets.SERVER_BASE_PATH }}
          EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
          HEALTH_CHECK_URL: ${{ secrets.HEALTH_CHECK_URL }}
          S3_BUCKET: ${{ secrets.S3_ARTIFACTS_BUCKET }}
          S3_KEY: ${{ steps.s3_upload.outputs.s3_key }}
        run: |
          set -euo pipefail
          
          AI_HEALTH_URL="${HEALTH_CHECK_URL%/health}/api/ai/health"
          
          BASE_PATH="$SERVER_BASE_PATH"
          AI_DIR="${BASE_PATH}/app/ai"
          AI_APP_DIR="${AI_DIR}/ai_app"
          BACKUP_DIR="${BASE_PATH}/backups/ai"
          TEMP_DIR="${AI_DIR}/deploy_temp"
          PM2_CONFIG="${BASE_PATH}/infra/pm2/ecosystem.ai.config.js"
          
          DEPLOY_SCRIPT=$(cat <<'SCRIPT_END'
          set -euo pipefail
          BASE_PATH="$1"
          AI_DIR="$2"
          AI_APP_DIR="$3"
          BACKUP_DIR="$4"
          TEMP_DIR="$5"
          PM2_CONFIG="$6"
          S3_BUCKET="$7"
          S3_KEY="$8"
          HEALTH_CHECK_URL="$9"
          
          APP_NAME="ai-service"
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          
          trap 'sudo -u ubuntu pm2 status || true; exit $?' ERR
          
          echo "============================================"
          echo "Re-Fit AI ë°°í¬ ì‹œì‘: $(date)"
          echo "============================================"
          
          mkdir -p $BACKUP_DIR $TEMP_DIR
          
          # S3ì—ì„œ íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ
          echo "S3ì—ì„œ íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
          aws s3 cp s3://$S3_BUCKET/$S3_KEY $TEMP_DIR/ --region ap-northeast-2 || {
            echo "ì—ëŸ¬: S3ì—ì„œ íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"
            exit 1
          }
          
          WHEEL_FILE=$(ls $TEMP_DIR/*.whl | head -1)
          if [ ! -f "$WHEEL_FILE" ]; then
            echo "ì—ëŸ¬: Wheel íŒ¨í‚¤ì§€ê°€ ì—†ìŠµë‹ˆë‹¤"
            rm -rf $TEMP_DIR
            exit 1
          fi
          
          # Wheel íŒŒì¼ í¬ê¸° ê²€ì¦
          WHEEL_SIZE=$(stat -c%s "$WHEEL_FILE" 2>/dev/null || echo 0)
          if [ "$WHEEL_SIZE" -lt 10000 ]; then
            echo "ì—ëŸ¬: Wheel íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ ì‘ìŠµë‹ˆë‹¤ (${WHEEL_SIZE} bytes)"
            rm -rf $TEMP_DIR
            exit 1
          fi
          echo "âœ… Wheel íŒŒì¼ í¬ê¸°: ${WHEEL_SIZE} bytes"
          
          # ê¸°ì¡´ ì½”ë“œ ë°±ì—…
          if [ -d "$AI_APP_DIR" ]; then
            echo "ê¸°ì¡´ ì½”ë“œ ë°±ì—… ì¤‘..."
            cp -r "$AI_APP_DIR" "$BACKUP_DIR/code_$TIMESTAMP"
            sudo chown -R ubuntu:ubuntu "$BACKUP_DIR/code_$TIMESTAMP" 2>/dev/null || true
            echo "âœ… ë°±ì—… ì™„ë£Œ: $BACKUP_DIR/code_$TIMESTAMP"
          fi
          
          # Wheel íŒŒì¼ ë°±ì—… (ë¡¤ë°±ìš©)
          echo "Wheel íŒŒì¼ ë°±ì—… ì¤‘..."
          mkdir -p "$BACKUP_DIR/wheel_$TIMESTAMP"
          cp "$WHEEL_FILE" "$BACKUP_DIR/wheel_$TIMESTAMP/"
          sudo chown -R ubuntu:ubuntu "$BACKUP_DIR/wheel_$TIMESTAMP" 2>/dev/null || true
          echo "âœ… Wheel ë°±ì—… ì™„ë£Œ"
          
          # ìƒˆ íŒ¨í‚¤ì§€ ì„¤ì¹˜
          echo "ìƒˆ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
          cd $AI_DIR
          source venv/bin/activate
          
          pip install "$WHEEL_FILE" --force-reinstall --no-cache-dir > /tmp/pip_install.log 2>&1 && {
            echo "âœ… íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ"
            tail -20 /tmp/pip_install.log
          } || {
            echo "âŒ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹¤íŒ¨"
            tail -50 /tmp/pip_install.log
            
            # ë¡¤ë°±
            if [ -d "$BACKUP_DIR/code_$TIMESTAMP" ]; then
              rm -rf "$AI_APP_DIR"
              cp -r "$BACKUP_DIR/code_$TIMESTAMP" "$AI_APP_DIR"
              sudo chown -R ubuntu:ubuntu "$AI_APP_DIR" 2>/dev/null || true
            fi
            sudo lsof -ti:8000 | xargs -r sudo kill -9 2>/dev/null || true
            sudo -u ubuntu pm2 restart ${APP_NAME} 2>/dev/null || true
            rm -rf $TEMP_DIR
            exit 1
          }
          
          rm -rf $TEMP_DIR
          sudo chown -R ubuntu:ubuntu "$AI_APP_DIR" 2>/dev/null || true
          
          # PM2 í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
          echo "AI ê´€ë ¨ PM2 í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ ì¤‘..."
          sudo lsof -ti:8000 | xargs -r sudo kill -9 2>/dev/null || true
          sudo -u ubuntu pm2 list | grep -E 'ai-service|ai-serv' | awk '{print $2}' | while read -r process_name; do
            if [ -n "$process_name" ] && [ "$process_name" != "name" ]; then
              sudo -u ubuntu pm2 stop "$process_name" 2>/dev/null || true
              sudo -u ubuntu pm2 delete "$process_name" 2>/dev/null || true
            fi
          done
          sleep 1
          
          # PM2ë¡œ ì„œë¹„ìŠ¤ ì‹œì‘
          echo "AI ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..."
          sudo -u ubuntu pm2 start $PM2_CONFIG --only ${APP_NAME} --env production || exit 1
          
          sleep 3
          sudo -u ubuntu pm2 describe ${APP_NAME} > /dev/null || exit 1
          
          # ì„œë¹„ìŠ¤ ì´ˆê¸°í™” ëŒ€ê¸°
          echo "ì„œë¹„ìŠ¤ ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘... (10ì´ˆ)"
          sleep 10
          
          # Caddy ë¦¬ë¡œë“œ
          systemctl is-active --quiet caddy && sudo systemctl reload caddy 2>/dev/null || true
          sleep 2
          
          # í—¬ìŠ¤ì²´í¬ (ìµœëŒ€ 10íšŒ ì¬ì‹œë„)
          echo "í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
          HEALTH_OK=false
          for i in {1..10}; do
            HTTP_STATUS=$(timeout 10 curl -s -o /dev/null -w "%{http_code}" "$HEALTH_CHECK_URL" 2>/dev/null || echo "000")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ! (HTTP $HTTP_STATUS)"
              HEALTH_OK=true
              break
            fi
            echo "âš ï¸  ì‹œë„ $i/10: HTTP $HTTP_STATUS"
            [ $i -lt 10 ] && sleep $((3 + i / 2))
          done
          
          if [ "$HEALTH_OK" = "true" ]; then
            sudo -u ubuntu pm2 save 2>/dev/null || true
            
            # 7ì¼ ì´ìƒ ëœ ë°±ì—… ì •ë¦¬
            (find $BACKUP_DIR -name "code_*" -type d -mtime +7 -exec rm -rf {} + 2>/dev/null) &
            (find $BACKUP_DIR -name "wheel_*" -type d -mtime +7 -exec rm -rf {} + 2>/dev/null) &
            
            echo ""
            echo "============================================"
            echo "Re-Fit AI ë°°í¬ ì™„ë£Œ: $(date)"
            echo "============================================"
            exit 0
          fi
          
          # í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ - ë¡¤ë°±
          echo ""
          echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ - ë¡¤ë°± ì‹œì‘"
          echo "=== PM2 ë¡œê·¸ (ìµœê·¼ 30ì¤„) ==="
          sudo -u ubuntu pm2 logs ${APP_NAME} --lines 30 --nostream || true
          
          if [ -d "$BACKUP_DIR/code_$TIMESTAMP" ]; then
            rm -rf "$AI_APP_DIR"
            cp -r "$BACKUP_DIR/code_$TIMESTAMP" "$AI_APP_DIR"
            sudo chown -R ubuntu:ubuntu "$AI_APP_DIR" 2>/dev/null || true
            
            sudo lsof -ti:8000 | xargs -r sudo kill -9 2>/dev/null || true
            sudo -u ubuntu pm2 restart ${APP_NAME} 2>/dev/null || true
            sleep 5
            
            HTTP_STATUS=$(timeout 10 curl -s -o /dev/null -w "%{http_code}" "$HEALTH_CHECK_URL" 2>/dev/null || echo "000")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… ë¡¤ë°± ì„±ê³µ - ì´ì „ ë²„ì „ìœ¼ë¡œ ë³µêµ¬ë¨"
              sudo -u ubuntu pm2 save 2>/dev/null || true
            else
              echo "âš ï¸  ë¡¤ë°± í›„ì—ë„ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (HTTP $HTTP_STATUS)"
            fi
          fi
          exit 1
          SCRIPT_END
          )
          
          # SSM ëª…ë ¹ ì‹¤í–‰
          DEPLOY_SCRIPT_ENCODED=$(echo "$DEPLOY_SCRIPT" | base64 -w 0)
          SSM_COMMAND="bash -c \"echo '$DEPLOY_SCRIPT_ENCODED' | base64 -d | bash -s -- '$BASE_PATH' '$AI_DIR' '$AI_APP_DIR' '$BACKUP_DIR' '$TEMP_DIR' '$PM2_CONFIG' '$S3_BUCKET' '$S3_KEY' '$AI_HEALTH_URL'\""
          PARAMETERS_JSON=$(jq -n --arg cmd "$SSM_COMMAND" '{commands: [$cmd]}')
          
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$EC2_INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters "$PARAMETERS_JSON" \
            --timeout-seconds 1800 \
            --region ap-northeast-2 \
            --query 'Command.CommandId' \
            --output text)
          
          [ -n "$COMMAND_ID" ] || exit 1
          
          echo "SSM Command ID: $COMMAND_ID"
          
          # SSM ëª…ë ¹ ì‹¤í–‰ ìƒíƒœ í™•ì¸
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$EC2_INSTANCE_ID" \
              --region ap-northeast-2 \
              --query 'Status' \
              --output text 2>/dev/null || echo "InProgress")
            
            if [ "$STATUS" = "Success" ]; then
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$EC2_INSTANCE_ID" \
                --region ap-northeast-2 \
                --query 'StandardOutputContent' \
                --output text
              echo "success=true" >> $GITHUB_OUTPUT
              exit 0
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              echo "SSM Command failed with status: $STATUS"
              echo "=== Standard Output ==="
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$EC2_INSTANCE_ID" \
                --region ap-northeast-2 \
                --query 'StandardOutputContent' \
                --output text
              echo "=== Standard Error ==="
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$EC2_INSTANCE_ID" \
                --region ap-northeast-2 \
                --query 'StandardErrorContent' \
                --output text
              echo "success=false" >> $GITHUB_OUTPUT
              exit 1
            fi
            [ $i -eq 1 ] && echo "Waiting for SSM command to complete..."
            [ $i -eq 30 ] && echo "Still waiting... (30/60 checks)"
            sleep 5
          done
          
          echo "SSM Command timeout after 60 checks"
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1

  # ==========================================
  # 3ë‹¨ê³„: ë°°í¬ í›„ ê²€ì¦ (Post-deployment Validation)
  # ==========================================
  post-deployment-validation:
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    environment: ${{ inputs.branch == 'main' && 'production' || 'development' }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      # ë°°í¬ í›„ ì¦‰ì‹œ ê¸°ë³¸ SLI í™•ì¸ (ì²˜ìŒ 5ë¶„)
      - name: Initial SLI Check (0-5min)
        id: initial_sli
        env:
          ENVIRONMENT: ${{ inputs.branch == 'main' && 'production' || 'development' }}
          HEALTH_CHECK_URL: ${{ secrets.HEALTH_CHECK_URL }}
        run: |
          echo "ğŸ” ë°°í¬ í›„ ì´ˆê¸° SLI í™•ì¸ (5ë¶„ ëŒ€ê¸°)"
          
          AI_HEALTH_URL="${HEALTH_CHECK_URL%/health}/api/ai/health"
          
          # 5ë¶„ê°„ 1ë¶„ë§ˆë‹¤ í—¬ìŠ¤ì²´í¬
          for i in {1..5}; do
            echo ""
            echo "[$i/5] í—¬ìŠ¤ì²´í¬ ì¤‘... ($(date))"
            
            HTTP_STATUS=$(timeout 10 curl -s -o /dev/null -w "%{http_code}" "$AI_HEALTH_URL" 2>/dev/null || echo "000")
            
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ (HTTP $HTTP_STATUS)"
            else
              echo "âš ï¸  í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (HTTP $HTTP_STATUS)"
              
              if [ $i -ge 3 ]; then
                echo "âŒ 3íšŒ ì´ìƒ ì—°ì† ì‹¤íŒ¨ - ë°°í¬ ê²€ì¦ ì‹¤íŒ¨"
                exit 1
              fi
            fi
            
            [ $i -lt 5 ] && sleep 60
          done
          
          echo ""
          echo "âœ… ì´ˆê¸° í—¬ìŠ¤ì²´í¬ í†µê³¼ (5ë¶„)"

      # CloudWatch SLO ê²€ì¦ (ë°°í¬ í›„ 10-15ë¶„ ë°ì´í„° ê¸°ë°˜)
      - name: Verify SLO Compliance (CloudWatch)
        id: slo_check
        continue-on-error: false
        env:
          ENVIRONMENT: ${{ inputs.branch == 'main' && 'production' || 'development' }}
        run: |
          echo "ğŸ” CloudWatch ê¸°ë°˜ SLO ê²€ì¦ ì‹œì‘ (10ë¶„ ëŒ€ê¸°)"
          
          # ë©”íŠ¸ë¦­ì´ CloudWatchì— ë°˜ì˜ë  ì‹œê°„ í™•ë³´
          sleep 600
          
          END_TIME=$(date -u +%Y-%m-%dT%H:%M:%S)
          START_TIME=$(date -u -d '15 minutes ago' +%Y-%m-%dT%H:%M:%S)
          
          echo "ğŸ“Š ì¸¡ì • ê¸°ê°„: $START_TIME ~ $END_TIME"
          
          # Tier 1 ê¸°ëŠ¥ë³„ SLO ê²€ì¦
          declare -A SLO_TARGETS=(
            ["DocumentAnalysis"]="93"
            ["Recommendation"]="97"
            ["ReportGeneration"]="93"
          )
          
          ALL_PASSED=true
          
          for feature in "${!SLO_TARGETS[@]}"; do
            TARGET=${SLO_TARGETS[$feature]}
            
            echo ""
            echo "=== $feature ê²€ì¦ (ëª©í‘œ: ${TARGET}%) ==="
            
            # ì„±ê³µë¥  ì¡°íšŒ
            SUCCESS_RATE=$(aws cloudwatch get-metric-statistics \
              --namespace "ReFit/AI" \
              --metric-name "${feature}SuccessRate" \
              --dimensions Name=Environment,Value=$ENVIRONMENT \
              --start-time $START_TIME \
              --end-time $END_TIME \
              --period 900 \
              --statistics Average \
              --query 'Datapoints[0].Average' \
              --output text)
            
            # P95 ì§€ì—°ì‹œê°„ ì¡°íšŒ
            LATENCY_P95=$(aws cloudwatch get-metric-statistics \
              --namespace "ReFit/AI" \
              --metric-name "${feature}Latency" \
              --dimensions Name=Environment,Value=$ENVIRONMENT \
              --start-time $START_TIME \
              --end-time $END_TIME \
              --period 900 \
              --extended-statistics p95 \
              --query 'Datapoints[0]."p95"' \
              --output text)
            
            # ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ìŠ¤í‚µ (ì•„ì§ ìš”ì²­ì´ ì—†ì„ ìˆ˜ ìˆìŒ)
            if [ "$SUCCESS_RATE" = "None" ] || [ -z "$SUCCESS_RATE" ]; then
              echo "â„¹ï¸  ì•„ì§ ë°ì´í„° ì—†ìŒ (ì‹ ê·œ ë°°í¬ ë˜ëŠ” ìš”ì²­ ì—†ìŒ)"
              continue
            fi
            
            SUCCESS_RATE=$(printf "%.2f" $SUCCESS_RATE)
            
            echo "  - ì„±ê³µë¥ : ${SUCCESS_RATE}% (ëª©í‘œ: ${TARGET}%)"
            
            if [ -n "$LATENCY_P95" ] && [ "$LATENCY_P95" != "None" ]; then
              echo "  - P95 ì§€ì—°ì‹œê°„: ${LATENCY_P95}ì´ˆ"
            fi
            
            # SLO ë‹¬ì„± ì—¬ë¶€ í™•ì¸
            if awk "BEGIN {exit !($SUCCESS_RATE >= $TARGET)}"; then
              echo "  âœ… SLO ë‹¬ì„±"
            else
              echo "  âŒ SLO ë¯¸ë‹¬ì„±"
              ALL_PASSED=false
            fi
          done
          
          echo ""
          if [ "$ALL_PASSED" = "true" ]; then
            echo "âœ… ëª¨ë“  SLO ê²€ì¦ í†µê³¼"
            echo "slo_status=passed" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  ì¼ë¶€ SLO ë¯¸ë‹¬ì„±"
            echo "slo_status=failed" >> $GITHUB_OUTPUT
          fi

      # SLO ê²€ì¦ ê²°ê³¼ë¥¼ Discordë¡œ ì „ì†¡
      - name: Report SLO Results to Discord
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          SLO_STATUS: ${{ steps.slo_check.outputs.slo_status }}
          BRANCH: ${{ inputs.branch }}
          SHA: ${{ needs.deploy.outputs.deployment_sha }}
          CLOUDWATCH_DASHBOARD_URL: ${{ secrets.CLOUDWATCH_AI_DASHBOARD_URL }}
          ERROR_BUDGET_STATUS: ${{ needs.pre-deployment-check.outputs.error_budget_status }}
        run: |
          if [ "$SLO_STATUS" = "failed" ]; then
            COLOR=16776960
            EMOJI="âš ï¸"
            TITLE="AI SLO ìœ„ë°˜ ê°ì§€"
            MESSAGE="ë°°í¬ëŠ” ì™„ë£Œë˜ì—ˆìœ¼ë‚˜ ì¼ë¶€ SLO ëª©í‘œë¥¼ ì¶©ì¡±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
          else
            COLOR=3066993
            EMOJI="âœ…"
            TITLE="AI ë°°í¬ ë° SLO ê²€ì¦ ì™„ë£Œ"
            MESSAGE="ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆê³  ëª¨ë“  SLOë¥¼ ì¶©ì¡±í•©ë‹ˆë‹¤."
          fi
          
          # Error Budget ìƒíƒœ ì¶”ê°€
          EB_STATUS="ì •ìƒ"
          EB_COLOR="ğŸŸ¢"
          if [ "$ERROR_BUDGET_STATUS" = "degraded" ]; then
            EB_STATUS="ì£¼ì˜"
            EB_COLOR="ğŸŸ¡"
          elif [ "$ERROR_BUDGET_STATUS" = "exceeded" ]; then
            EB_STATUS="ì´ˆê³¼"
            EB_COLOR="ğŸ”´"
          fi
          
          payload=$(cat <<EOF
          {
            "embeds": [{
              "title": "$EMOJI $TITLE",
              "color": $COLOR,
              "description": "$MESSAGE",
              "fields": [
                {"name": "ë¸Œëœì¹˜", "value": "\`$BRANCH\`", "inline": true},
                {"name": "ì»¤ë°‹", "value": "\`${SHA:0:7}\`", "inline": true},
                {"name": "Error Budget", "value": "$EB_COLOR $EB_STATUS", "inline": true},
                {"name": "CloudWatch", "value": "[ëŒ€ì‹œë³´ë“œ ë³´ê¸°](${CLOUDWATCH_DASHBOARD_URL:-https://console.aws.amazon.com/cloudwatch})", "inline": false}
              ],
              "footer": { "text": "Re-Fit AI CD" },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )
          
          curl -H "Content-Type: application/json" -X POST -d "$payload" "$DISCORD_WEBHOOK"

  # ==========================================
  # ìµœì¢…: ë°°í¬ ê²°ê³¼ ì•Œë¦¼
  # ==========================================
  notify-result:
    runs-on: ubuntu-latest
    needs: [pre-deployment-check, deploy, post-deployment-validation]
    if: always()
    steps:
      - name: Notify Discord on Final Result
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          PRE_CHECK_RESULT: ${{ needs.pre-deployment-check.result }}
          DEPLOY_RESULT: ${{ needs.deploy.result }}
          POST_CHECK_RESULT: ${{ needs.post-deployment-validation.result }}
          BRANCH: ${{ inputs.branch }}
          SHA: ${{ needs.deploy.outputs.deployment_sha }}
          RUN_ID: ${{ github.run_id }}
        run: |
          # ìµœì¢… ìƒíƒœ íŒë‹¨
          if [ "$DEPLOY_RESULT" = "success" ] && [ "$POST_CHECK_RESULT" = "success" ]; then
            EMOJI="âœ…"
            COLOR=3066993
            TITLE="AI ë°°í¬ ì™„ì „ ì„±ê³µ"
            MESSAGE="ëª¨ë“  ê²€ì¦ì„ í†µê³¼í•˜ê³  ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
          elif [ "$DEPLOY_RESULT" = "success" ]; then
            EMOJI="âš ï¸"
            COLOR=16776960
            TITLE="AI ë°°í¬ ë¶€ë¶„ ì„±ê³µ"
            MESSAGE="ë°°í¬ëŠ” ì™„ë£Œë˜ì—ˆìœ¼ë‚˜ ì‚¬í›„ ê²€ì¦ì—ì„œ ì¼ë¶€ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            EMOJI="ğŸš¨"
            COLOR=15158332
            TITLE="AI ë°°í¬ ì‹¤íŒ¨"
            MESSAGE="ë°°í¬ ê³¼ì •ì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
          fi

          # ë‹¨ê³„ë³„ ìƒíƒœ
          PRE_ICON="âœ…"
          [ "$PRE_CHECK_RESULT" != "success" ] && PRE_ICON="âŒ"
          
          DEPLOY_ICON="âœ…"
          [ "$DEPLOY_RESULT" != "success" ] && DEPLOY_ICON="âŒ"
          
          POST_ICON="âœ…"
          [ "$POST_CHECK_RESULT" != "success" ] && POST_ICON="âŒ"

          payload=$(cat <<EOF
          {
            "embeds": [{
              "title": "$EMOJI $TITLE",
              "color": $COLOR,
              "description": "$MESSAGE",
              "fields": [
                {"name": "ì„œë¹„ìŠ¤", "value": "Re-Fit AI", "inline": true},
                {"name": "ë¸Œëœì¹˜", "value": "\`$BRANCH\`", "inline": true},
                {"name": "ì»¤ë°‹", "value": "\`${SHA:0:7}\`", "inline": true},
                {"name": "ê²€ì¦ ë‹¨ê³„", "value": "$PRE_ICON ë°°í¬ ì „ ê²€ì¦\n$DEPLOY_ICON ë°°í¬ ì‹¤í–‰\n$POST_ICON ë°°í¬ í›„ ê²€ì¦", "inline": false},
                {"name": "ì›Œí¬í”Œë¡œìš°", "value": "[ìƒì„¸ ë³´ê¸°](https://github.com/${{ github.repository }}/actions/runs/$RUN_ID)", "inline": false}
              ],
              "footer": { "text": "Re-Fit AI CD" },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )

          curl -H "Content-Type: application/json" -X POST -d "$payload" "$DISCORD_WEBHOOK"