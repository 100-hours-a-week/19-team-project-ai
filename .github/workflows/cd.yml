name: Re-Fit AI CD

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'CI workflow run ID (ÏûêÎèô ÏûÖÎ†• ÎòêÎäî ÏßÅÏ†ë ÏûÖÎ†•)'
        required: false
        type: string
      sha:
        description: 'Commit SHA (ÏûêÎèô ÏûÖÎ†• ÎòêÎäî ÏßÅÏ†ë ÏûÖÎ†•)'
        required: false
        type: string
      branch:
        description: 'Branch name'
        required: true
        type: choice
        default: 'develop'
        options:
          - develop
          - main
      use_latest_artifact:
        description: 'run_id/shaÎ•º ÏûÖÎ†•ÌïòÏßÄ ÏïäÏúºÎ©¥ ÏÑ†ÌÉùÌïú Î∏åÎûúÏπòÏùò ÏµúÏã† ÏïÑÌã∞Ìå©Ìä∏ ÏÇ¨Ïö©'
        required: true
        type: boolean
        default: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.branch == 'main' && 'production' || 'development' }}
    steps:
      - name: Find Latest Artifact (if needed)
        if: inputs.use_latest_artifact == true && (inputs.run_id == '' || inputs.sha == '')
        id: find-artifact
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const branch = '${{ inputs.branch }}';
            console.log(`Finding latest artifact for branch: ${branch}`);

            // CI ÏõåÌÅ¨ÌîåÎ°úÏö∞Ïùò ÏµúÍ∑º ÏÑ±Í≥µÌïú Ïã§Ìñâ Ï∞æÍ∏∞
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci.yml',
              branch: branch,
              status: 'success',
              per_page: 10
            });

            if (runs.data.workflow_runs.length === 0) {
              core.setFailed(`No successful CI runs found for branch: ${branch}`);
              return;
            }

            // ÏïÑÌã∞Ìå©Ìä∏Í∞Ä ÏûàÎäî ÏµúÏã† Ïã§Ìñâ Ï∞æÍ∏∞
            for (const run of runs.data.workflow_runs) {
              const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: run.id
              });

              const buildArtifact = artifacts.data.artifacts.find(
                a => a.name.startsWith('ai-wheel-')
              );

              if (buildArtifact) {
                const sha = run.head_sha;
                console.log(`Found artifact from run #${run.run_number}`);
                console.log(`   Run ID: ${run.id}`);
                console.log(`   SHA: ${sha}`);
                console.log(`   Created: ${run.created_at}`);

                core.setOutput('run_id', run.id.toString());
                core.setOutput('sha', sha);
                core.setOutput('run_number', run.run_number.toString());
                return;
              }
            }

            core.setFailed(`No artifacts found in recent CI runs for branch: ${branch}`);

      - name: Set Deployment Variables
        id: deploy-vars
        run: |
          if [ "${{ inputs.use_latest_artifact }}" == "true" ] && [ -z "${{ inputs.run_id }}" ]; then
            echo "run_id=${{ steps.find-artifact.outputs.run_id }}" >> $GITHUB_OUTPUT
            echo "sha=${{ steps.find-artifact.outputs.sha }}" >> $GITHUB_OUTPUT
            echo "Using latest artifact from run #${{ steps.find-artifact.outputs.run_number }}"
          else
            echo "run_id=${{ inputs.run_id }}" >> $GITHUB_OUTPUT
            echo "sha=${{ inputs.sha }}" >> $GITHUB_OUTPUT
            echo "Using manually specified artifact"
          fi

      - name: Download Wheel Package
        uses: actions/download-artifact@v4
        with:
          name: ai-wheel-${{ steps.deploy-vars.outputs.sha }}
          path: build-output/dist
          github-token: ${{ secrets.PAT }}
          run-id: ${{ steps.deploy-vars.outputs.run_id }}

      - name: Download Deployment Files
        uses: actions/download-artifact@v4
        with:
          name: ai-deploy-files-${{ steps.deploy-vars.outputs.sha }}
          path: build-output
          github-token: ${{ secrets.PAT }}
          run-id: ${{ steps.deploy-vars.outputs.run_id }}

      - name: Verify Downloaded Files
        run: |
          echo "=== Verifying downloaded files ==="
          ls -la build-output/
          
          # Wheel Ìå®ÌÇ§ÏßÄ ÌôïÏù∏ (ÌïÑÏàò)
          if [ -d "build-output/dist" ] && [ -n "$(ls -A build-output/dist/*.whl 2>/dev/null)" ]; then
            echo "‚úÖ Wheel package found"
            ls -lh build-output/dist/
          else
            echo "‚ùå Wheel package not found"
            exit 1
          fi
          
          # pyproject.toml ÌôïÏù∏ (ÌïÑÏàò)
          if [ -f "build-output/pyproject.toml" ]; then
            echo "‚úÖ pyproject.toml found"
          else
            echo "‚ö†Ô∏è  pyproject.toml not found (optional)"
          fi
          
          # ÏÜåÏä§ ÌååÏùº ÌôïÏù∏ (ÏÑ†ÌÉùÏ†Å)
          if [ -d "build-output/ai_app" ]; then
            echo "‚úÖ Source files found"
          else
            echo "‚ö†Ô∏è  Source files not found (optional)"
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Upload Wheel Package to S3
        id: s3_upload
        run: |
          set -euo pipefail
          COMMIT_SHA=${{ steps.deploy-vars.outputs.sha }}
          S3_KEY="artifacts/ai/${COMMIT_SHA}/$(basename build-output/dist/*.whl)"
          
          echo "Uploading wheel package to s3://${{ secrets.S3_ARTIFACTS_BUCKET }}/$S3_KEY"
          aws s3 cp build-output/dist/*.whl s3://${{ secrets.S3_ARTIFACTS_BUCKET }}/$S3_KEY
          
          echo "s3_key=$S3_KEY" >> $GITHUB_OUTPUT
      - name: Deploy via SSM
        env:
          SERVER_BASE_PATH: ${{ secrets.SERVER_BASE_PATH }}
          EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
          HEALTH_CHECK_URL: ${{ secrets.HEALTH_CHECK_URL }}
          S3_BUCKET: ${{ secrets.S3_ARTIFACTS_BUCKET }}
          S3_KEY: ${{ steps.s3_upload.outputs.s3_key }}
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail
          
          # AI Ìó¨Ïä§Ï≤¥ÌÅ¨ URL ÏàòÏ†ï (FastAPI prefix Ï†ÅÏö©)
          # /health ‚Üí /api/ai/health
          AI_HEALTH_URL="${HEALTH_CHECK_URL%/health}/api/ai/health"
          
          BASE_PATH="$SERVER_BASE_PATH"
          AI_DIR="${BASE_PATH}/app/ai"
          AI_APP_DIR="${AI_DIR}/ai_app"
          BACKUP_DIR="${BASE_PATH}/backups/ai"
          TEMP_DIR="${AI_DIR}/deploy_temp"
          PM2_CONFIG="${BASE_PATH}/infra/pm2/ecosystem.ai.config.js"
          
          DEPLOY_SCRIPT=$(cat <<'SCRIPT_END'
          set -euo pipefail
          BASE_PATH="$1"
          AI_DIR="$2"
          AI_APP_DIR="$3"
          BACKUP_DIR="$4"
          TEMP_DIR="$5"
          PM2_CONFIG="$6"
          S3_BUCKET="$7"
          S3_KEY="$8"
          HEALTH_CHECK_URL="$9"
          DISCORD_WEBHOOK="${10}"
          GITHUB_REPOSITORY="${11}"
          
          APP_NAME="ai-service"
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          
          trap 'sudo -u ubuntu pm2 status || true; exit $?' ERR
          
          echo "============================================"
          echo "Re-Fit AI Î∞∞Ìè¨ ÏãúÏûë: $(date)"
          echo "============================================"
          
          mkdir -p $BACKUP_DIR $TEMP_DIR
          
          # S3ÏóêÏÑú Ìå®ÌÇ§ÏßÄ Îã§Ïö¥Î°úÎìú
          echo "S3ÏóêÏÑú Ìå®ÌÇ§ÏßÄ Îã§Ïö¥Î°úÎìú Ï§ë..."
          aws s3 cp s3://$S3_BUCKET/$S3_KEY $TEMP_DIR/ --region ap-northeast-2 || {
            echo "ÏóêÎü¨: S3ÏóêÏÑú Ìå®ÌÇ§ÏßÄ Îã§Ïö¥Î°úÎìú Ïã§Ìå®"
            exit 1
          }
          
          if [ ! -f "$TEMP_DIR"/*.whl ]; then
            echo "ÏóêÎü¨: Wheel Ìå®ÌÇ§ÏßÄÍ∞Ä Îã§Ïö¥Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§."
            rm -rf $TEMP_DIR
            exit 1
          fi
          
          # Wheel ÌååÏùº ÌÅ¨Í∏∞ Í≤ÄÏ¶ù (10KB Ïù¥ÏÉÅ)
          WHEEL_FILE=$(ls $TEMP_DIR/*.whl | head -1)
          WHEEL_SIZE=$(stat -f%z "$WHEEL_FILE" 2>/dev/null || stat -c%s "$WHEEL_FILE" 2>/dev/null || echo 0)
          if [ "$WHEEL_SIZE" -lt 10000 ]; then
            echo "ÏóêÎü¨: Wheel ÌååÏùº ÌÅ¨Í∏∞Í∞Ä ÎÑàÎ¨¥ ÏûëÏäµÎãàÎã§. (${WHEEL_SIZE} bytes < 10KB)"
            rm -rf $TEMP_DIR
            exit 1
          fi
          echo "Wheel ÌååÏùº ÌÅ¨Í∏∞: ${WHEEL_SIZE} bytes"
          
          # Í∏∞Ï°¥ ÏΩîÎìú Î∞±ÏóÖ
          if [ -d "$AI_APP_DIR" ]; then
            echo "Í∏∞Ï°¥ ÏΩîÎìú Î∞±ÏóÖ Ï§ë..."
            cp -r "$AI_APP_DIR" "$BACKUP_DIR/code_$TIMESTAMP"
            echo "Î∞±ÏóÖ ÏôÑÎ£å: $BACKUP_DIR/code_$TIMESTAMP"
          fi
          
          # Wheel ÌååÏùº Î∞±ÏóÖ (Î°§Î∞±Ïö©)
          echo "Wheel ÌååÏùº Î∞±ÏóÖ Ï§ë..."
          mkdir -p "$BACKUP_DIR/wheel_$TIMESTAMP"
          cp "$WHEEL_FILE" "$BACKUP_DIR/wheel_$TIMESTAMP/"
          echo "Wheel Î∞±ÏóÖ ÏôÑÎ£å: $BACKUP_DIR/wheel_$TIMESTAMP/$(basename $WHEEL_FILE)"
          
          # Î∞±ÏóÖ ÎîîÎ†âÌÜ†Î¶¨ Í∂åÌïú ÏÑ§Ï†ï (Î°§Î∞± Ïãú ubuntu Ïú†Ï†ÄÍ∞Ä Ï†ëÍ∑º Í∞ÄÎä•ÌïòÎèÑÎ°ù)
          sudo chown -R ubuntu:ubuntu "$BACKUP_DIR/code_$TIMESTAMP" 2>/dev/null || true
          sudo chown -R ubuntu:ubuntu "$BACKUP_DIR/wheel_$TIMESTAMP" 2>/dev/null || true
          
          # ÏÉà Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò
          echo "ÏÉà Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò Ï§ë..."
          cd $AI_DIR
          source venv/bin/activate
          
          # pip install (Î°úÍ∑∏Îäî ÌååÏùºÎ°ú, ÏßÑÌñâÏÉÅÌô©Îßå ÌëúÏãú)
          echo "Installing packages..."
          pip install "$WHEEL_FILE" --force-reinstall --no-cache-dir > /tmp/pip_install.log 2>&1 && {
            echo "‚úÖ Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò ÏôÑÎ£å"
            tail -20 /tmp/pip_install.log
          } || {
            echo "‚ùå Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò Ïã§Ìå®"
            echo ""
            echo "=== ÏÑ§Ïπò Î°úÍ∑∏ (ÎßàÏßÄÎßâ 50Ï§Ñ) ==="
            tail -50 /tmp/pip_install.log
            echo ""
            echo "=== ÏÑ§Ïπò Ïã§Ìå® - Î°§Î∞± ÏãúÏûë ==="
            if [ -d "$BACKUP_DIR/code_$TIMESTAMP" ]; then
              rm -rf "$AI_APP_DIR"
              cp -r "$BACKUP_DIR/code_$TIMESTAMP" "$AI_APP_DIR"
              sudo chown -R ubuntu:ubuntu "$AI_APP_DIR" 2>/dev/null || true
            fi
            sudo lsof -ti:8000 | xargs -r sudo kill -9 2>/dev/null || true
            sudo -u ubuntu pm2 stop ${APP_NAME} 2>/dev/null || true
            sudo -u ubuntu pm2 delete ${APP_NAME} 2>/dev/null || true
            sudo -u ubuntu pm2 start $PM2_CONFIG --only ${APP_NAME} --env production 2>/dev/null || true
            rm -rf $TEMP_DIR
            exit 1
          }
          
          echo "Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò ÏôÑÎ£å"
          rm -rf $TEMP_DIR
          
          # Í∂åÌïú ÏÑ§Ï†ï
          sudo chown -R ubuntu:ubuntu "$AI_APP_DIR" 2>/dev/null || true
          
          # 8000Î≤à Ìè¨Ìä∏Î•º ÏÇ¨Ïö©ÌïòÎäî ÌîÑÎ°úÏÑ∏Ïä§ Ï¢ÖÎ£å
          echo "8000Î≤à Ìè¨Ìä∏Î•º ÏÇ¨Ïö©ÌïòÎäî ÌîÑÎ°úÏÑ∏Ïä§ Ï¢ÖÎ£å Ï§ë..."
          sudo lsof -ti:8000 | xargs -r sudo kill -9 2>/dev/null || true
          
          # Î™®Îì† AI Í¥ÄÎ†® PM2 ÌîÑÎ°úÏÑ∏Ïä§ Ï†ïÎ¶¨ (ai-service, ai-serv Îì± Î™®Îëê Ï†ïÎ¶¨)
          echo "Î™®Îì† AI Í¥ÄÎ†® PM2 ÌîÑÎ°úÏÑ∏Ïä§ Ï†ïÎ¶¨ Ï§ë..."
          sudo -u ubuntu pm2 list | grep -E 'ai-service|ai-serv' | awk '{print $2}' | while read -r process_name; do
            if [ -n "$process_name" ] && [ "$process_name" != "name" ]; then
              echo "ÌîÑÎ°úÏÑ∏Ïä§ Ï†ïÎ¶¨: $process_name"
              sudo -u ubuntu pm2 stop "$process_name" 2>/dev/null || true
              sudo -u ubuntu pm2 delete "$process_name" 2>/dev/null || true
            fi
          done
          sleep 1
          
          # ÏµúÏ¢Ö ÌôïÏù∏: ÌòπÏãú ÎÇ®ÏïÑÏûàÎäî AI Í¥ÄÎ†® ÌîÑÎ°úÏÑ∏Ïä§ Í∞ïÏ†ú Ï†ïÎ¶¨
          sudo -u ubuntu pm2 list | grep -q 'ai-' && {
            echo "Í≤ΩÍ≥†: ÏïÑÏßÅ AI Í¥ÄÎ†® ÌîÑÎ°úÏÑ∏Ïä§Í∞Ä ÎÇ®ÏïÑÏûàÏùå. Ï†ÑÏ≤¥ Ï†ïÎ¶¨..."
            sudo -u ubuntu pm2 delete all 2>/dev/null || true
          } || true
          
          # PM2Î°ú Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò ÏãúÏûë
          echo "AI ÏÑúÎπÑÏä§ ÏãúÏûë Ï§ë..."
          sudo -u ubuntu pm2 start $PM2_CONFIG --only ${APP_NAME} --env production || exit 1
          
          # PM2 ÌîÑÎ°úÏÑ∏Ïä§ ÌôïÏù∏
          sleep 3
          sudo -u ubuntu pm2 describe ${APP_NAME} > /dev/null || exit 1
          
          # ÏÑúÎπÑÏä§ Ï¥àÍ∏∞Ìôî ÎåÄÍ∏∞ (Python import, Î™®Îç∏ Î°úÎî© Îì±)
          echo "ÏÑúÎπÑÏä§ Ï¥àÍ∏∞Ìôî ÎåÄÍ∏∞ Ï§ë..."
          sleep 10
          
          # Caddy Î¶¨Î°úÎìú
          systemctl is-active --quiet caddy && sudo systemctl reload caddy 2>/dev/null || true
          sleep 2
          
          # Ìó¨Ïä§Ï≤¥ÌÅ¨ (ÏµúÎåÄ 10Ìöå Ïû¨ÏãúÎèÑ, Ï†êÏßÑÏ†Å ÎåÄÍ∏∞)
          echo "Ìó¨Ïä§Ï≤¥ÌÅ¨ ÏãúÏûë..."
          HEALTH_OK=false
          for i in {1..10}; do
            HTTP_STATUS=$(timeout 10 curl -s -o /dev/null -w "%{http_code}" "$HEALTH_CHECK_URL" 2>/dev/null || echo "000")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "‚úÖ Í∏∞Î≥∏ Ìó¨Ïä§Ï≤¥ÌÅ¨ ÏÑ±Í≥µ! (HTTP $HTTP_STATUS)"
              HEALTH_OK=true
              break
            fi
            echo "‚ö†Ô∏è  ÏãúÎèÑ $i/10: HTTP $HTTP_STATUS (ÎåÄÍ∏∞ Ï§ë...)"
            [ $i -lt 10 ] && sleep $((3 + i / 2))
          done
          
          if [ "$HEALTH_OK" != "true" ]; then
            echo "‚ùå Í∏∞Î≥∏ Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìå®"
            # Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìå® Î°úÏßÅÏúºÎ°ú Ïù¥Îèô
          else
            # Ïä§Î™®ÌÅ¨ ÌÖåÏä§Ìä∏ Ïã§Ìñâ (SLI/SLO Í∏∞Î≥∏ Í≤ÄÏ¶ù)
            echo ""
            echo "============================================"
            echo "SLO Ïä§Î™®ÌÅ¨ ÌÖåÏä§Ìä∏ ÏãúÏûë"
            echo "============================================"
            
            SMOKE_TEST_FAILED=false
            
            # Test 1: Ï∂îÏ≤ú API (SLO: P95 < 3Ï¥à, ÏÑ±Í≥µÎ•† > 97%)
            echo ""
            echo "üìä Test 1/2: Ï∂îÏ≤ú API Í≤ÄÏ¶ù..."
            START_TIME=$(date +%s%3N)
            RESPONSE=$(timeout 5 curl -s -X POST "$HEALTH_CHECK_URL/../recommendations" \
              -H "Content-Type: application/json" \
              -d '{"user_id": "test", "interest": "backend"}' 2>/dev/null || echo "TIMEOUT")
            END_TIME=$(date +%s%3N)
            DURATION=$(( (END_TIME - START_TIME) ))
            DURATION_SEC=$(echo "scale=2; $DURATION / 1000" | bc)
            
            if [ "$RESPONSE" = "TIMEOUT" ] || [ -z "$RESPONSE" ]; then
              echo "  ‚ùå Ï∂îÏ≤ú API ÌÉÄÏûÑÏïÑÏõÉ ÎòêÎäî Ïã§Ìå®"
              SMOKE_TEST_FAILED=true
            elif (( $(echo "$DURATION_SEC > 3.0" | bc -l) )); then
              echo "  ‚ö†Ô∏è  Ï∂îÏ≤ú API ÏùëÎãµ ÏãúÍ∞Ñ: ${DURATION_SEC}Ï¥à (Î™©Ìëú: < 3Ï¥à, SLO Ï¥àÍ≥º)"
              echo "  ‚Üí Í≤ΩÍ≥†Îßå ÌëúÏãú, Î∞∞Ìè¨Îäî Í≥ÑÏÜç"
            else
              echo "  ‚úÖ Ï∂îÏ≤ú API: ${DURATION_SEC}Ï¥à (Î™©Ìëú: < 3Ï¥à, SLO Îã¨ÏÑ±)"
            fi
            
            # Test 2: Ìó¨Ïä§Ï≤¥ÌÅ¨ ÏÉÅÏÑ∏ ÏùëÎãµ ÌôïÏù∏
            echo ""
            echo "üìä Test 2/2: Ìó¨Ïä§Ï≤¥ÌÅ¨ ÏÉÅÏÑ∏ ÏùëÎãµ Í≤ÄÏ¶ù..."
            HEALTH_RESPONSE=$(timeout 5 curl -s "$HEALTH_CHECK_URL" 2>/dev/null || echo "")
            
            if echo "$HEALTH_RESPONSE" | grep -q '"status"'; then
              echo "  ‚úÖ Ìó¨Ïä§Ï≤¥ÌÅ¨ ÏùëÎãµ ÌòïÏãù Ï†ïÏÉÅ"
            else
              echo "  ‚ö†Ô∏è  Ìó¨Ïä§Ï≤¥ÌÅ¨ ÏùëÎãµ ÌòïÏãù ÌôïÏù∏ ÌïÑÏöî: $HEALTH_RESPONSE"
            fi
            
            echo ""
            echo "============================================"
            
            if [ "$SMOKE_TEST_FAILED" = "true" ]; then
              echo "‚ùå Ïä§Î™®ÌÅ¨ ÌÖåÏä§Ìä∏ Ïã§Ìå® - Î°§Î∞± ÌïÑÏöî"
              echo "============================================"
              # Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìå® Î°úÏßÅÏúºÎ°ú Ïù¥Îèô
            else
              echo "‚úÖ Ïä§Î™®ÌÅ¨ ÌÖåÏä§Ìä∏ ÌÜµÍ≥º!"
              echo "============================================"
              
              # PM2 ÏÉÅÌÉú Ï†ÄÏû•
              sudo -u ubuntu pm2 save 2>/dev/null || true
              
              # 7Ïùº Ïù¥ÏÉÅ Îêú Î∞±ÏóÖ Ï†ïÎ¶¨
              (find $BACKUP_DIR -name "code_*" -type d -mtime +7 -exec rm -rf {} + 2>/dev/null) &
              
              echo ""
              echo "============================================"
              echo "Re-Fit AI Î∞∞Ìè¨ ÏôÑÎ£å: $(date)"
              echo "============================================"
              exit 0
            fi
          fi
          
          # Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìå® - PM2 Î°úÍ∑∏ ÌôïÏù∏
          echo ""
          echo "‚ùå Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìå® - PM2 Î°úÍ∑∏ ÌôïÏù∏ Ï§ë..."
          echo "=== PM2 ÏÉÅÌÉú ==="
          sudo -u ubuntu pm2 describe ${APP_NAME} || true
          echo ""
          echo "=== ÏµúÍ∑º Î°úÍ∑∏ (30Ï§Ñ) ==="
          sudo -u ubuntu pm2 logs ${APP_NAME} --lines 30 --nostream || true
          echo ""
          
          # Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìå® Ïãú Î°§Î∞±
          echo "Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìå®, Î°§Î∞± ÏãúÎèÑ Ï§ë..."
          BACKUP_DIR_PATH="$BACKUP_DIR/code_$TIMESTAMP"
          if [ -d "$BACKUP_DIR_PATH" ]; then
            rm -rf "$AI_APP_DIR"
            cp -r "$BACKUP_DIR_PATH" "$AI_APP_DIR"
            sudo chown -R ubuntu:ubuntu "$AI_APP_DIR" 2>/dev/null || true
            
            # 8000Î≤à Ìè¨Ìä∏Î•º ÏÇ¨Ïö©ÌïòÎäî ÌîÑÎ°úÏÑ∏Ïä§ Ï¢ÖÎ£å
            sudo lsof -ti:8000 | xargs -r sudo kill -9 2>/dev/null || true
            
            # Î™®Îì† AI Í¥ÄÎ†® PM2 ÌîÑÎ°úÏÑ∏Ïä§ Ï†ïÎ¶¨ (Î°§Î∞± ÏãúÏóêÎèÑ ÏôÑÏ†Ñ Ï†ïÎ¶¨)
            echo "Î°§Î∞±: Î™®Îì† AI Í¥ÄÎ†® PM2 ÌîÑÎ°úÏÑ∏Ïä§ Ï†ïÎ¶¨ Ï§ë..."
            sudo -u ubuntu pm2 list | grep -E 'ai-service|ai-serv' | awk '{print $2}' | while read -r process_name; do
              if [ -n "$process_name" ] && [ "$process_name" != "name" ]; then
                echo "Î°§Î∞±: ÌîÑÎ°úÏÑ∏Ïä§ Ï†ïÎ¶¨: $process_name"
                sudo -u ubuntu pm2 stop "$process_name" 2>/dev/null || true
                sudo -u ubuntu pm2 delete "$process_name" 2>/dev/null || true
              fi
            done
            sleep 1
            
            # Íπ®ÎÅóÌïòÍ≤å Ï†ïÎ¶¨ ÌõÑ Ïû¨ÏãúÏûë
            sudo -u ubuntu pm2 start $PM2_CONFIG --only ${APP_NAME} --env production
            sleep 2
            
            # Î°§Î∞± ÌõÑ Ìó¨Ïä§Ï≤¥ÌÅ¨ (1ÌöåÎßå, Îπ†Î•∏ ÌôïÏù∏)
            sleep 5
            HTTP_STATUS=$(timeout 10 curl -s -o /dev/null -w "%{http_code}" "$HEALTH_CHECK_URL" 2>/dev/null || echo "000")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "‚úÖ Î°§Î∞± ÏÑ±Í≥µ - Ïù¥Ï†Ñ Î≤ÑÏ†ÑÏúºÎ°ú Î≥µÍµ¨Îê®"
              sudo -u ubuntu pm2 save 2>/dev/null || true
            else
              echo "‚ö†Ô∏è  Î°§Î∞± ÌõÑÏóêÎèÑ Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìå® (HTTP $HTTP_STATUS)"
              echo "PM2 Î°úÍ∑∏ ÌôïÏù∏ ÌïÑÏöî:"
              sudo -u ubuntu pm2 logs ${APP_NAME} --lines 20 --nostream || true
            fi
          fi
          exit 1
          SCRIPT_END
          )
          
          # SSM Î™ÖÎ†π Ïã§Ìñâ (base64 Ïù∏ÏΩîÎî©ÏúºÎ°ú ÌäπÏàòÎ¨∏Ïûê Ïù¥Ïä§ÏºÄÏù¥ÌîÑ Î¨∏Ï†ú Î∞©ÏßÄ)
          DEPLOY_SCRIPT_ENCODED=$(echo "$DEPLOY_SCRIPT" | base64 -w 0)
          SSM_COMMAND="bash -c \"echo '$DEPLOY_SCRIPT_ENCODED' | base64 -d | bash -s -- '$BASE_PATH' '$AI_DIR' '$AI_APP_DIR' '$BACKUP_DIR' '$TEMP_DIR' '$PM2_CONFIG' '$S3_BUCKET' '$S3_KEY' '$AI_HEALTH_URL' '$DISCORD_WEBHOOK' '$GITHUB_REPOSITORY'\""
          PARAMETERS_JSON=$(jq -n --arg cmd "$SSM_COMMAND" '{commands: [$cmd]}')
          
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$EC2_INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters "$PARAMETERS_JSON" \
            --timeout-seconds 1800 \
            --region ap-northeast-2 \
            --query 'Command.CommandId' \
            --output text)
          
          [ -n "$COMMAND_ID" ] || exit 1
          
          echo "SSM Command ID: $COMMAND_ID"
          
          # SSM Î™ÖÎ†π Ïã§Ìñâ ÏÉÅÌÉú ÌôïÏù∏ (ÏµúÎåÄ 60Ìöå, 5Î∂Ñ)
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$EC2_INSTANCE_ID" \
              --region ap-northeast-2 \
              --query 'Status' \
              --output text 2>/dev/null || echo "InProgress")
            
            if [ "$STATUS" = "Success" ]; then
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$EC2_INSTANCE_ID" \
                --region ap-northeast-2 \
                --query 'StandardOutputContent' \
                --output text
              exit 0
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              echo "SSM Command failed with status: $STATUS"
              echo "=== Standard Output ==="
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$EC2_INSTANCE_ID" \
                --region ap-northeast-2 \
                --query 'StandardOutputContent' \
                --output text
              echo "=== Standard Error ==="
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$EC2_INSTANCE_ID" \
                --region ap-northeast-2 \
                --query 'StandardErrorContent' \
                --output text
              exit 1
            fi
            [ $i -eq 1 ] && echo "Waiting for SSM command to complete..."
            [ $i -eq 30 ] && echo "Still waiting... (30/60 checks completed)"
            sleep 5
          done
          
          echo "SSM Command timeout after 60 checks"
          echo "=== Final Status ==="
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$EC2_INSTANCE_ID" \
            --region ap-northeast-2 \
            --query '[Status, StandardOutputContent, StandardErrorContent]' \
            --output text
          exit 1

      - name: Notify Discord on Result
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          STATUS: ${{ job.status }}
          BRANCH: ${{ inputs.branch }}
          SHA: ${{ steps.deploy-vars.outputs.sha }}
          RUN_ID: ${{ github.run_id }}
        run: |
          if [ "$STATUS" = "success" ]; then
            EMOJI="‚úÖ"
            COLOR=3066993
            TITLE="AI Î∞∞Ìè¨ ÏÑ±Í≥µ"
          else
            EMOJI="üö®"
            COLOR=15158332
            TITLE="AI Î∞∞Ìè¨ Ïã§Ìå®"
          fi

          payload=$(cat <<EOF
          {
            "embeds": [{
              "title": "$EMOJI $TITLE",
              "color": $COLOR,
              "fields": [
                {"name": "ÏÑúÎπÑÏä§", "value": "Re-Fit AI", "inline": true},
                {"name": "Î∏åÎûúÏπò", "value": "\`$BRANCH\`", "inline": true},
                {"name": "Ïª§Î∞ã SHA", "value": "\`$SHA\`", "inline": false},
                {"name": "ÏõåÌÅ¨ÌîåÎ°úÏö∞", "value": "[ÏÉÅÏÑ∏ Î≥¥Í∏∞](https://github.com/${{ github.repository }}/actions/runs/$RUN_ID)", "inline": false}
              ],
              "footer": { "text": "Re-Fit CD" },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )

          curl -H "Content-Type: application/json" -X POST -d "$payload" "$DISCORD_WEBHOOK"
