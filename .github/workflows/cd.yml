name: Re-Fit AI CD

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'CI workflow run ID (ìë™ ì…ë ¥ ë˜ëŠ” ì§ì ‘ ì…ë ¥)'
        required: false
        type: string
      sha:
        description: 'Commit SHA (ìë™ ì…ë ¥ ë˜ëŠ” ì§ì ‘ ì…ë ¥)'
        required: false
        type: string
      branch:
        description: 'Branch name'
        required: true
        type: choice
        default: 'develop'
        options:
          - develop
          - main
      use_latest_artifact:
        description: 'run_id/shaë¥¼ ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ ì„ íƒí•œ ë¸Œëœì¹˜ì˜ ìµœì‹  ì•„í‹°íŒ©íŠ¸ ì‚¬ìš©'
        required: true
        type: boolean
        default: true

env:
  PYTHON_VERSION: '3.11'
  SERVER_AI_DIR: '/home/ubuntu/refit/app/ai'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.branch == 'main' && 'production' || 'development' }}
    steps:
      - name: Find Latest Artifact (if needed)
        if: inputs.use_latest_artifact == true && (inputs.run_id == '' || inputs.sha == '')
        id: find-artifact
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branch = '${{ inputs.branch }}';
            console.log(`ğŸ” Finding latest artifact for branch: ${branch}`);

            // CI ì›Œí¬í”Œë¡œìš°ì˜ ìµœê·¼ ì„±ê³µí•œ ì‹¤í–‰ ì°¾ê¸°
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci.yml',
              branch: branch,
              status: 'success',
              per_page: 10
            });

            if (runs.data.workflow_runs.length === 0) {
              core.setFailed(`âŒ No successful CI runs found for branch: ${branch}`);
              return;
            }

            // ì•„í‹°íŒ©íŠ¸ê°€ ìˆëŠ” ìµœì‹  ì‹¤í–‰ ì°¾ê¸°
            for (const run of runs.data.workflow_runs) {
              const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: run.id
              });

              const buildArtifact = artifacts.data.artifacts.find(
                a => a.name.startsWith('ai-wheel-')
              );

              if (buildArtifact) {
                const sha = run.head_sha;
                console.log(`âœ… Found artifact from run #${run.run_number}`);
                console.log(`   Run ID: ${run.id}`);
                console.log(`   SHA: ${sha}`);
                console.log(`   Created: ${run.created_at}`);

                core.setOutput('run_id', run.id.toString());
                core.setOutput('sha', sha);
                core.setOutput('run_number', run.run_number.toString());
                return;
              }
            }

            core.setFailed(`âŒ No artifacts found in recent CI runs for branch: ${branch}`);

      - name: Set Deployment Variables
        id: deploy-vars
        run: |
          if [ "${{ inputs.use_latest_artifact }}" == "true" ] && [ -z "${{ inputs.run_id }}" ]; then
            echo "run_id=${{ steps.find-artifact.outputs.run_id }}" >> $GITHUB_OUTPUT
            echo "sha=${{ steps.find-artifact.outputs.sha }}" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Using latest artifact from run #${{ steps.find-artifact.outputs.run_number }}"
          else
            echo "run_id=${{ inputs.run_id }}" >> $GITHUB_OUTPUT
            echo "sha=${{ inputs.sha }}" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Using manually specified artifact"
          fi

      # ===========================================
      # 1. Artifact ë‹¤ìš´ë¡œë“œ
      # ===========================================
      - name: Download Wheel Package
        uses: actions/download-artifact@v4
        with:
          name: ai-wheel-${{ steps.deploy-vars.outputs.sha }}
          path: build-output/dist
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.deploy-vars.outputs.run_id }}
      
      - name: Download Deployment Files
        uses: actions/download-artifact@v4
        with:
          name: ai-deploy-files-${{ steps.deploy-vars.outputs.sha }}
          path: build-output
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.deploy-vars.outputs.run_id }}
      
      # ===========================================
      # 2. ë‹¤ìš´ë¡œë“œ íŒŒì¼ ê²€ì¦
      # ===========================================
      - name: Verify Downloaded Files
        run: |
          echo "=== Verifying downloaded files ==="
          ls -la build-output/
          
          if [ -d "build-output/dist" ] && [ -n "$(ls -A build-output/dist/*.whl 2>/dev/null)" ]; then
            echo "Wheel package found"
            ls -lh build-output/dist/
          else
            echo "Wheel package not found"
            exit 1
          fi
          
          if [ -f "build-output/ai_app/requirements.txt" ]; then
            echo "requirements.txt found"
          else
            echo "requirements.txt not found"
            exit 1
          fi
      
      # ===========================================
      # 3. AWS ìê²© ì¦ëª… ì„¤ì •
      # ===========================================
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'ap-northeast-2' }}
      
      # ===========================================
      # 4. S3ì— Wheel íŒ¨í‚¤ì§€ ì—…ë¡œë“œ
      # ===========================================
      - name: Upload Wheel Package to S3
        run: |
          COMMIT_SHA=${{ github.event.workflow_run.head_sha || github.sha }}
          S3_KEY="ai-deployments/${COMMIT_SHA}/$(basename build-output/dist/*.whl)"
          
          echo "Uploading wheel package to s3://${{ secrets.S3_ARTIFACTS_BUCKET }}/$S3_KEY"
          aws s3 cp build-output/dist/*.whl s3://${{ secrets.S3_ARTIFACTS_BUCKET }}/$S3_KEY
          
          echo "S3_KEY=$S3_KEY" >> $GITHUB_ENV
          echo "COMMIT_SHA=$COMMIT_SHA" >> $GITHUB_ENV
      
      # ===========================================
      # 5. SSMì„ í†µí•œ ë°°í¬ ì‹¤í–‰
      # ===========================================
      - name: Execute Deployment via SSM
        run: |
          set -e
          
          SERVER_AI_DIR="${{ env.SERVER_AI_DIR }}"
          S3_BUCKET="${{ secrets.S3_ARTIFACTS_BUCKET }}"
          S3_KEY="${{ env.S3_KEY }}"
          AWS_REGION="${{ secrets.AWS_REGION || 'ap-northeast-2' }}"
          HEALTH_CHECK_URL="${{ secrets.HEALTH_CHECK_URL }}"
          
          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
          DEPLOY_SCRIPT=$(cat <<DEPLOY_EOF
          set -e
          
          SERVER_AI_DIR="$SERVER_AI_DIR"
          AI_APP_DIR="$SERVER_AI_DIR/ai_app"
          BACKUP_DIR="/home/ubuntu/refit/backups/ai"
          LOG_DIR="/home/ubuntu/refit/logs/ai"
          TEMP_DIR="$SERVER_AI_DIR/deploy_temp"
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          S3_BUCKET="$S3_BUCKET"
          S3_KEY="$S3_KEY"
          AWS_REGION="$AWS_REGION"
          HEALTH_CHECK_URL="$HEALTH_CHECK_URL"
          
          echo "============================================"
          echo "Re-Fit AI ë°°í¬ ì‹œì‘: $(date)"
          echo "============================================"
          
          rollback() {
            echo "!!! ë°°í¬ ì‹¤íŒ¨: ìë™ ë¡¤ë°±ì„ ì‹œì‘í•©ë‹ˆë‹¤ !!!"
            if [ -d "$BACKUP_DIR/code_$TIMESTAMP" ]; then
              rm -rf "$AI_APP_DIR"
              cp -r "$BACKUP_DIR/code_$TIMESTAMP" "$AI_APP_DIR"
              echo "ì½”ë“œ ë¡¤ë°± ì™„ë£Œ"
            fi
            pm2 reload ai-service --update-env
            echo "ë°°í¬ ì‹¤íŒ¨ - ì´ì „ ë²„ì „ìœ¼ë¡œ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤."
            rm -rf $TEMP_DIR
            exit 1
          }
          
          mkdir -p $BACKUP_DIR $LOG_DIR $TEMP_DIR
          
          if [ ! -f "$SERVER_AI_DIR/.env" ]; then
            echo ".env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. (í™˜ê²½ ë³€ìˆ˜ ë¯¸ì‚¬ìš© ì‹œ ì •ìƒ)"
          else
            echo ".env íŒŒì¼ í™•ì¸ë¨"
          fi
          
          echo "S3ì—ì„œ íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
          aws s3 cp s3://$S3_BUCKET/$S3_KEY $TEMP_DIR/ --region $AWS_REGION || {
            echo "ì—ëŸ¬: S3ì—ì„œ íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"
            exit 1
          }
          
          if [ ! -f "$TEMP_DIR"/*.whl ]; then
            echo "ì—ëŸ¬: Wheel íŒ¨í‚¤ì§€ê°€ ë‹¤ìš´ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            rm -rf $TEMP_DIR
            exit 1
          fi
          
          if [ -d "$AI_APP_DIR" ]; then
            echo "ê¸°ì¡´ ì½”ë“œ ë°±ì—… ì¤‘..."
            cp -r "$AI_APP_DIR" "$BACKUP_DIR/code_$TIMESTAMP"
            echo "ë°±ì—… ì™„ë£Œ: $BACKUP_DIR/code_$TIMESTAMP"
          fi
          
          echo "ìƒˆ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
          cd $SERVER_AI_DIR
          source venv/bin/activate
          
          pip install "$TEMP_DIR"/*.whl --force-reinstall || rollback
          
          echo "íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ"
          
          rm -rf $TEMP_DIR
          
          echo "AI ì„œë¹„ìŠ¤ ë¬´ì¤‘ë‹¨ ì¬ì‹œì‘ ì¤‘..."
          PM2_CONFIG="/home/ubuntu/refit/infra/pm2/ecosystem.ai.config.js"
          
          if pm2 describe ai-service > /dev/null 2>&1; then
            echo "ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ë¬´ì¤‘ë‹¨ ì¬ì‹œì‘ (Reload)..."
            pm2 reload ai-service --update-env
          else
            echo "ì‹ ê·œ í”„ë¡œì„¸ìŠ¤ ì‹œì‘..."
            pm2 start $PM2_CONFIG --env production
          fi
          
          echo "ë°°í¬ ê²€ì¦ ì¤‘..."
          for i in {1..5}; do
            sleep 5
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_CHECK_URL 2>/dev/null || echo "000")
            
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "ë°°í¬ ì„±ê³µ! (HTTP $HTTP_STATUS)"
              
              pm2 save
              
              find $BACKUP_DIR -name "code_*" -type d -mtime +7 -exec rm -rf {} + 2>/dev/null || true
              
              echo "============================================"
              echo "Re-Fit AI ë°°í¬ ì™„ë£Œ: $(date)"
              echo "============================================"
              exit 0
            fi
            
            echo "Health check ì‹œë„ ì¤‘... ($i/5) - HTTP $HTTP_STATUS"
          done
          
          echo "í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ - ë¡¤ë°±ì„ ì‹œì‘í•©ë‹ˆë‹¤."
          rollback
          DEPLOY_EOF
          )
          
          echo "SSMì„ í†µí•´ ë°°í¬ ëª…ë ¹ ì‹¤í–‰ ì¤‘..."
          
          # ìŠ¤í¬ë¦½íŠ¸ë¥¼ base64ë¡œ ì¸ì½”ë”©í•˜ì—¬ S3ì— ì—…ë¡œë“œ
          echo "$DEPLOY_SCRIPT" | base64 > /tmp/deploy_script.b64
          SCRIPT_S3_KEY="ssm-scripts/ai-deploy-$(date +%s).sh"
          aws s3 cp /tmp/deploy_script.b64 s3://$S3_BUCKET/$SCRIPT_S3_KEY --region $AWS_REGION
          
          # SSM ëª…ë ¹ ì‹¤í–‰: S3ì—ì„œ ìŠ¤í¬ë¦½íŠ¸ ë‹¤ìš´ë¡œë“œ í›„ ì‹¤í–‰
          PARAMS_JSON="{\"commands\":[\"aws s3 cp s3://$S3_BUCKET/$SCRIPT_S3_KEY /tmp/deploy_script.b64 --region $AWS_REGION\",\"base64 -d /tmp/deploy_script.b64 > /tmp/deploy_script.sh\",\"chmod +x /tmp/deploy_script.sh\",\"bash /tmp/deploy_script.sh\",\"rm -f /tmp/deploy_script.sh /tmp/deploy_script.b64\"]}"
          
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --parameters "$PARAMS_JSON" \
            --output-s3-bucket-name "${{ secrets.S3_ARTIFACTS_BUCKET }}" \
            --output-s3-key-prefix "ssm-outputs/ai-deploy" \
            --region $AWS_REGION \
            --query 'Command.CommandId' \
            --output text)
          
          echo "Command ID: $COMMAND_ID"
          
          echo "ë°°í¬ ëª…ë ¹ ì‹¤í–‰ ëŒ€ê¸° ì¤‘..."
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --region $AWS_REGION \
            --max-attempts 120 \
            --delay 5 || {
            echo "ë°°í¬ ëª…ë ¹ ì‹¤í–‰ ì‹¤íŒ¨ ë˜ëŠ” íƒ€ì„ì•„ì›ƒ"
            exit 1
          }
          
          OUTPUT=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --region $AWS_REGION \
            --query '[Status, StandardOutputContent, StandardErrorContent]' \
            --output text)
          
          STATUS=$(echo "$OUTPUT" | cut -f1)
          STDOUT=$(echo "$OUTPUT" | cut -f2)
          STDERR=$(echo "$OUTPUT" | cut -f3)
          
          echo "=== ë°°í¬ ê²°ê³¼ ==="
          echo "Status: $STATUS"
          echo "=== í‘œì¤€ ì¶œë ¥ ==="
          echo "$STDOUT"
          echo "=== í‘œì¤€ ì—ëŸ¬ ==="
          echo "$STDERR"
          
          if [ "$STATUS" != "Success" ]; then
            echo "ë°°í¬ ì‹¤íŒ¨: Status=$STATUS"
            exit 1
          fi
          
          echo "ë°°í¬ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
