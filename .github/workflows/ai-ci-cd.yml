name: Re-Fit AI Integrated CI/CD

on:
  pull_request:
    branches: [develop, main]
    types: [opened, synchronize, reopened]
  push:
    branches: [develop, main]

env:
  PYTHON_VERSION: '3.11'
  WORKING_DIRECTORY: 'ai_app'
  SERVER_AI_DIR: '/home/ubuntu/refit/app/ai'

jobs:
  # ===========================================
  # Feature/Chore/Hotfix PR 검증 (병렬 실행)
  # ===========================================
  lint:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: Run Ruff & MyPy
        run: |
          pip install ruff mypy
          ruff check .
          ruff format --check .
          mypy . --ignore-missing-imports || true

  test:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: Run Unit Tests
        run: |
          if [ -f ${{ env.WORKING_DIRECTORY }}/requirements.txt ]; then pip install -r ${{ env.WORKING_DIRECTORY }}/requirements.txt; fi
          pip install pytest pytest-cov pytest-asyncio
          if [ -d "tests" ]; then
            pytest tests/ -v --cov=${{ env.WORKING_DIRECTORY }} --cov-report=xml
          elif [ -d "${{ env.WORKING_DIRECTORY }}/tests" ]; then
            pytest ${{ env.WORKING_DIRECTORY }}/tests -v --cov=${{ env.WORKING_DIRECTORY }} --cov-report=xml
          else
            echo "No tests found"
          fi

  build-check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Verify Application Starts
        run: |
          if [ -f ${{ env.WORKING_DIRECTORY }}/requirements.txt ]; then pip install -r ${{ env.WORKING_DIRECTORY }}/requirements.txt; fi
          export PYTHONPATH=$PYTHONPATH:$(pwd)/${{ env.WORKING_DIRECTORY }}
          timeout 10s python -c "from api.main import app; print('Application loaded successfully')" || true

  sonar:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Run Tests with Coverage
        run: |
          if [ -f ${{ env.WORKING_DIRECTORY }}/requirements.txt ]; then pip install -r ${{ env.WORKING_DIRECTORY }}/requirements.txt; fi
          pip install pytest pytest-cov
          if [ -d "tests" ]; then
            pytest tests/ -v --cov=${{ env.WORKING_DIRECTORY }} --cov-report=xml
          elif [ -d "${{ env.WORKING_DIRECTORY }}/tests" ]; then
            pytest ${{ env.WORKING_DIRECTORY }}/tests -v --cov=${{ env.WORKING_DIRECTORY }} --cov-report=xml
          else
            echo "No tests found, skipping coverage"
          fi
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================
  # Develop 브랜치 통합 검증
  # ===========================================
  integration:
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install Dependencies
        run: |
          pip install pytest pytest-cov pytest-asyncio httpx
          if [ -f ${{ env.WORKING_DIRECTORY }}/requirements.txt ]; then pip install -r ${{ env.WORKING_DIRECTORY }}/requirements.txt; fi
      - name: Run All Tests
        run: |
          if [ -d "tests" ]; then
            pytest tests/ -v --cov=${{ env.WORKING_DIRECTORY }} --cov-report=xml
          elif [ -d "${{ env.WORKING_DIRECTORY }}/tests" ]; then
            pytest ${{ env.WORKING_DIRECTORY }}/tests -v --cov=${{ env.WORKING_DIRECTORY }} --cov-report=xml
          else
            echo "No tests found"
          fi
      - name: Security Scan (Safety)
        run: |
          pip install safety
          if [ -f ${{ env.WORKING_DIRECTORY }}/requirements.txt ]; then safety check -r ${{ env.WORKING_DIRECTORY }}/requirements.txt || true; fi
        continue-on-error: true
      - name: Security Scan (Bandit)
        run: |
          pip install bandit
          bandit -r ${{ env.WORKING_DIRECTORY }}/ -ll
        continue-on-error: true

  # ===========================================
  # Main 브랜치 릴리즈 빌드
  # ===========================================
  release:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install Dependencies
        run: |
          pip install pytest pytest-cov pytest-asyncio httpx
          if [ -f ${{ env.WORKING_DIRECTORY }}/requirements.txt ]; then pip install -r ${{ env.WORKING_DIRECTORY }}/requirements.txt; fi
      - name: Run Full Tests
        run: |
          if [ -d "tests" ]; then
            pytest tests/ -v --cov=${{ env.WORKING_DIRECTORY }} --cov-report=xml
          elif [ -d "${{ env.WORKING_DIRECTORY }}/tests" ]; then
            pytest ${{ env.WORKING_DIRECTORY }}/tests -v --cov=${{ env.WORKING_DIRECTORY }} --cov-report=xml
          else
            echo "No tests found"
          fi
      - name: Get Version
        id: version
        run: |
          VERSION=$(grep -E "^version\s*=" pyproject.toml | sed 's/.*"\(.*\)"/\1/' || echo "0.1.0")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"
      - name: Create Release Package
        run: |
          pip install build
          python -m build --wheel
      - name: Upload Release Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ai-service-${{ steps.version.outputs.version }}
          path: |
            dist/
            ${{ env.WORKING_DIRECTORY }}/requirements.txt
            ${{ env.WORKING_DIRECTORY }}/
          retention-days: 14
      - name: Create Git Tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ steps.version.outputs.version }}" -m "Release v${{ steps.version.outputs.version }}" || true
          git push origin "v${{ steps.version.outputs.version }}" || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy:
    needs: release
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: ai-service-${{ needs.release.outputs.version }}
          path: ./dist

      - name: Deploy Wheel to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "dist/*.whl"
          target: "${{ env.SERVER_AI_DIR }}/deploy_temp"

      - name: Execute Server Deploy with Rollback
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          envs: SERVER_AI_DIR
          script: |
            # --- 변수 설정 ---
            AI_APP_DIR="$SERVER_AI_DIR/ai_app"
            BACKUP_DIR="/home/ubuntu/refit/backups/ai"
            TIMESTAMP=$(date +%Y%m%d%H%M%S)

            # --- 롤백 함수 ---
            rollback() {
              echo "!!! 배포 실패: 자동 롤백을 시작합니다 !!!"
              if [ -d "$BACKUP_DIR/code_$TIMESTAMP" ]; then
                rm -rf "$AI_APP_DIR"
                cp -r "$BACKUP_DIR/code_$TIMESTAMP" "$AI_APP_DIR"
              fi
              sudo systemctl restart fastapi
              sudo truncate -s 0 /etc/caddy/maintenance.conf
              sudo systemctl reload caddy
              exit 1
            }

            # 1. [Caddy 점검 페이지 ON]
            sudo cp /etc/caddy/maintenance_pretty.conf /etc/caddy/maintenance.conf
            sudo systemctl reload caddy

            # 2. [로컬 코드 백업]
            mkdir -p $BACKUP_DIR
            if [ -d "$AI_APP_DIR" ]; then
              cp -r "$AI_APP_DIR" "$BACKUP_DIR/code_$TIMESTAMP"
            fi

            # 3. [패키지 설치 및 업데이트]
            cd $SERVER_AI_DIR
            source venv/bin/activate
            pip install ./deploy_temp/dist/*.whl --force-reinstall || rollback
            rm -rf ./deploy_temp

            # 4. [서비스 재시작]
            sudo systemctl restart fastapi

            # 5. [헬스 체크] 5회 재시도
            echo "최종 확인 중..."
            for i in {1..5}; do
              sleep 5
              HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health || echo "000")
              if [ "$HTTP_STATUS" = "200" ]; then
                echo "--- 배포 성공! 점검 페이지 해제 ---"
                sudo truncate -s 0 /etc/caddy/maintenance.conf
                sudo systemctl reload caddy
                ls -dt $BACKUP_DIR/code_* | tail -n +6 | xargs rm -rf || true
                exit 0
              fi
              echo "Health check 시도 중... ($i/5)"
            done
            rollback
