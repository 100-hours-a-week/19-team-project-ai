name: Re-Fit AI Integrated CI/CD (Single YAML Master)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    types: [ opened, synchronize, reopened ]
    branches: [ develop ]

jobs:
  # [CI 단계] 정적 분석 및 유닛 테스트
  ci-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black pytest
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # 1. [정적 분석] flake8(구문/에러) 및 black(포맷팅) 검사
      # - name: Static Analysis (Lint & Format)
      #   run: |
      #     flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
      #     black --check .

      # 2. [유닛 테스트]
      - name: Run Unit Tests
        run: pytest || echo "No tests found or tests failed"

  # [CD 단계] S3 백업, DB 스냅샷, 배포 및 자동 롤백
  deploy:
    needs: ci-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 3. [S3 코드 백업] 배포될 최신 코드를 S3에 업로드
      - name: Sync Code to S3
        run: |
          aws s3 sync . s3://${{ secrets.S3_BUCKET_NAME }}/code/${{ github.sha }} --exclude ".git/*"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_KEY }}
          AWS_DEFAULT_REGION: ap-northeast-2

      # 4. [서버 배포] SSH를 통해 단일 명령어로 모든 배포 로직 실행
      - name: Deploy to Server with Rollback
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          envs: GITHUB_SHA
          script: |
            # --- 변수 및 환경 설정 ---
            AI_DIR="/home/ubuntu/refit/app/ai"
            AI_APP_DIR="$AI_DIR/ai_app"
            BACKUP_DIR="/home/ubuntu/refit/backups/ai"
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            S3_BUCKET="${{ secrets.S3_BUCKET_NAME }}"
            DB_NAME="${{ secrets.DB_NAME }}"
            
            # --- 롤백 함수 정의 (실패 시 호출) ---
            rollback() {
              echo "!!! 배포 실패: 자동 롤백을 시작합니다 !!!"
              # 1. 코드 복구 (로컬 백업 사용)
              if [ -d "$BACKUP_DIR/code_$TIMESTAMP" ]; then
                rm -rf "$AI_APP_DIR"
                cp -r "$BACKUP_DIR/code_$TIMESTAMP" "$AI_APP_DIR"
              fi
              # 2. DB 복구 (스냅샷 사용)
              if [ -f "$BACKUP_DIR/db_snap_$TIMESTAMP.sql" ]; then
                psql -d $DB_NAME < "$BACKUP_DIR/db_snap_$TIMESTAMP.sql"
              fi
              # 3. 서비스 복구
              sudo systemctl restart fastapi
              sudo truncate -s 0 /etc/caddy/maintenance.conf
              sudo systemctl reload caddy
              exit 1
            }

            # --- 배포 시작 ---
            echo "--- 배포 프로세스 시작 ($TIMESTAMP) ---"

            # 5. [Caddy 점검 페이지 ON]
            echo 'handle { respond "System Updating..." 503 }' | sudo tee /etc/caddy/maintenance.conf
            sudo systemctl reload caddy

            # 6. [DB 스냅샷 & S3 업로드]
            echo "DB 스냅샷 생성 중..."
            mkdir -p $BACKUP_DIR
            pg_dump $DB_NAME > "$BACKUP_DIR/db_snap_$TIMESTAMP.sql"
            aws s3 cp "$BACKUP_DIR/db_snap_$TIMESTAMP.sql" "s3://$S3_BUCKET/db-backups/"

            # 7. [로컬 코드 백업]
            cp -r "$AI_APP_DIR" "$BACKUP_DIR/code_$TIMESTAMP"

            # 8. [소스 업데이트] S3에서 최신 아티팩트 가져오기
            aws s3 sync "s3://$S3_BUCKET/code/$GITHUB_SHA" "$AI_APP_DIR" --delete || rollback

            # 9. [의존성 설치 및 Systemd 재시작]
            cd "$AI_DIR"
            source venv/bin/activate
            pip install -r "$AI_APP_DIR/requirements.txt" || rollback
            sudo systemctl restart fastapi

            # 10. [헬스 체크 및 롤백 결정]
            echo "최종 확인 중..."
            sleep 10
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health || echo "000")

            if [ "$HTTP_STATUS" = "200" ]; then
              echo "--- 배포 성공! 점검 페이지를 해제합니다 ---"
              sudo truncate -s 0 /etc/caddy/maintenance.conf
              sudo systemctl reload caddy
            else
              rollback
            fi