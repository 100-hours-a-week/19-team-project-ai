name: Re-Fit AI CD (Prod)

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'CI workflow run ID (ìë™ ì…ë ¥ ë˜ëŠ” ì§ì ‘ ì…ë ¥)'
        required: false
        type: string
      sha:
        description: 'Commit SHA (ìë™ ì…ë ¥ ë˜ëŠ” ì§ì ‘ ì…ë ¥)'
        required: false
        type: string
      branch:
        description: 'Branch name'
        required: true
        type: choice
        default: 'main'
        options:
          - main
      use_latest_artifact:
        description: 'run_id/shaë¥¼ ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ ì„ íƒí•œ ë¸Œëœì¹˜ì˜ ìµœì‹  ì•„í‹°íŒ©íŠ¸ ì‚¬ìš©'
        required: true
        type: boolean
        default: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    outputs:
      deployment_success: ${{ steps.deploy.outputs.success }}
      deployment_sha: ${{ steps.deploy-vars.outputs.sha }}
    steps:
      - name: Find Latest Artifact (if needed)
        if: inputs.use_latest_artifact == true && (inputs.run_id == '' || inputs.sha == '')
        id: find-artifact
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const branch = '${{ inputs.branch }}';
            console.log(`Finding latest artifact for branch: ${branch}`);

            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci.yml',
              branch: branch,
              status: 'success',
              per_page: 10
            });

            if (runs.data.workflow_runs.length === 0) {
              core.setFailed(`No successful CI runs found for branch: ${branch}`);
              return;
            }

            for (const run of runs.data.workflow_runs) {
              const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: run.id
              });

              const buildArtifact = artifacts.data.artifacts.find(
                a => a.name.startsWith('ai-wheel-')
              );

              if (buildArtifact) {
                const sha = run.head_sha;
                console.log(`Found artifact from run #${run.run_number}`);
                console.log(`   Run ID: ${run.id}`);
                console.log(`   SHA: ${sha}`);
                console.log(`   Created: ${run.created_at}`);

                core.setOutput('run_id', run.id.toString());
                core.setOutput('sha', sha);
                core.setOutput('run_number', run.run_number.toString());
                return;
              }
            }

            core.setFailed(`No artifacts found in recent CI runs for branch: ${branch}`);

      - name: Set Deployment Variables
        id: deploy-vars
        run: |
          if [ "${{ inputs.use_latest_artifact }}" == "true" ] && [ -z "${{ inputs.run_id }}" ]; then
            echo "run_id=${{ steps.find-artifact.outputs.run_id }}" >> $GITHUB_OUTPUT
            echo "sha=${{ steps.find-artifact.outputs.sha }}" >> $GITHUB_OUTPUT
            echo "Using latest artifact from run #${{ steps.find-artifact.outputs.run_number }}"
          else
            echo "run_id=${{ inputs.run_id }}" >> $GITHUB_OUTPUT
            echo "sha=${{ inputs.sha }}" >> $GITHUB_OUTPUT
            echo "Using manually specified artifact"
          fi

      - name: Download Wheel Package
        uses: actions/download-artifact@v4
        with:
          name: ai-wheel-${{ steps.deploy-vars.outputs.sha }}
          path: build-output/dist
          github-token: ${{ secrets.PAT }}
          run-id: ${{ steps.deploy-vars.outputs.run_id }}

      - name: Download Deployment Files
        uses: actions/download-artifact@v4
        with:
          name: ai-deploy-files-${{ steps.deploy-vars.outputs.sha }}
          path: build-output
          github-token: ${{ secrets.PAT }}
          run-id: ${{ steps.deploy-vars.outputs.run_id }}

      - name: Verify Downloaded Files
        run: |
          echo "=== Verifying downloaded files ==="
          ls -la build-output/

          if [ -d "build-output/dist" ] && [ -n "$(ls -A build-output/dist/*.whl 2>/dev/null)" ]; then
            echo "âœ… Wheel package found"
            ls -lh build-output/dist/
          else
            echo "âŒ Wheel package not found"
            exit 1
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Upload Wheel Package to S3
        id: s3_upload
        run: |
          set -euo pipefail
          COMMIT_SHA=${{ steps.deploy-vars.outputs.sha }}
          S3_KEY="artifacts/ai/${COMMIT_SHA}/$(basename build-output/dist/*.whl)"

          echo "Uploading wheel package to s3://${{ secrets.S3_ARTIFACTS_BUCKET }}/$S3_KEY"
          aws s3 cp build-output/dist/*.whl s3://${{ secrets.S3_ARTIFACTS_BUCKET }}/$S3_KEY

          echo "s3_key=$S3_KEY" >> $GITHUB_OUTPUT

      - name: Deploy via SSM
        id: deploy
        env:
          SERVER_BASE_PATH: ${{ secrets.SERVER_BASE_PATH }}
          EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
          HEALTH_CHECK_URL: ${{ secrets.HEALTH_CHECK_URL }}
          S3_BUCKET: ${{ secrets.S3_ARTIFACTS_BUCKET }}
          S3_KEY: ${{ steps.s3_upload.outputs.s3_key }}
        run: |
          set -euo pipefail

          AI_HEALTH_URL="${HEALTH_CHECK_URL%/health}/api/ai/health"

          BASE_PATH="$SERVER_BASE_PATH"
          AI_DIR="${BASE_PATH}/app/ai"
          AI_APP_DIR="${AI_DIR}/ai_app"
          BACKUP_DIR="${BASE_PATH}/backups/ai"
          TEMP_DIR="${AI_DIR}/deploy_temp"
          PM2_CONFIG="${BASE_PATH}/infra/pm2/ecosystem.ai.config.js"

          DEPLOY_SCRIPT=$(cat <<'SCRIPT_END'
          set -euo pipefail
          BASE_PATH="$1"
          AI_DIR="$2"
          AI_APP_DIR="$3"
          BACKUP_DIR="$4"
          TEMP_DIR="$5"
          PM2_CONFIG="$6"
          S3_BUCKET="$7"
          S3_KEY="$8"
          HEALTH_CHECK_URL="$9"

          APP_NAME="ai-service"
          TIMESTAMP=$(date +%Y%m%d%H%M%S)

          trap 'sudo -u ubuntu pm2 status || true; exit $?' ERR

          echo "============================================"
          echo "Re-Fit AI í”„ë¡œë•ì…˜ ë°°í¬ ì‹œì‘: $(date)"
          echo "============================================"

          mkdir -p $BACKUP_DIR $TEMP_DIR

          # S3ì—ì„œ íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ
          echo "S3ì—ì„œ íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
          aws s3 cp s3://$S3_BUCKET/$S3_KEY $TEMP_DIR/ --region ap-northeast-2 || {
            echo "ì—ëŸ¬: S3ì—ì„œ íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"
            exit 1
          }

          WHEEL_FILE=$(ls $TEMP_DIR/*.whl | head -1)
          if [ ! -f "$WHEEL_FILE" ]; then
            echo "ì—ëŸ¬: Wheel íŒ¨í‚¤ì§€ê°€ ì—†ìŠµë‹ˆë‹¤"
            rm -rf $TEMP_DIR
            exit 1
          fi

          # Wheel íŒŒì¼ í¬ê¸° ê²€ì¦
          WHEEL_SIZE=$(stat -c%s "$WHEEL_FILE" 2>/dev/null || echo 0)
          if [ "$WHEEL_SIZE" -lt 10000 ]; then
            echo "ì—ëŸ¬: Wheel íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ ì‘ìŠµë‹ˆë‹¤ (${WHEEL_SIZE} bytes)"
            rm -rf $TEMP_DIR
            exit 1
          fi
          echo "âœ… Wheel íŒŒì¼ í¬ê¸°: ${WHEEL_SIZE} bytes"

          # ê¸°ì¡´ ì½”ë“œ ë°±ì—…
          if [ -d "$AI_APP_DIR" ]; then
            echo "ê¸°ì¡´ ì½”ë“œ ë°±ì—… ì¤‘..."
            cp -r "$AI_APP_DIR" "$BACKUP_DIR/code_$TIMESTAMP"
            sudo chown -R ubuntu:ubuntu "$BACKUP_DIR/code_$TIMESTAMP" 2>/dev/null || true
            echo "âœ… ë°±ì—… ì™„ë£Œ: $BACKUP_DIR/code_$TIMESTAMP"
          fi

          # Wheel íŒŒì¼ ë°±ì—… (ë¡¤ë°±ìš©)
          echo "Wheel íŒŒì¼ ë°±ì—… ì¤‘..."
          mkdir -p "$BACKUP_DIR/wheel_$TIMESTAMP"
          cp "$WHEEL_FILE" "$BACKUP_DIR/wheel_$TIMESTAMP/"
          sudo chown -R ubuntu:ubuntu "$BACKUP_DIR/wheel_$TIMESTAMP" 2>/dev/null || true
          echo "âœ… Wheel ë°±ì—… ì™„ë£Œ"

          # ìƒˆ íŒ¨í‚¤ì§€ ì„¤ì¹˜
          echo "ìƒˆ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
          cd $AI_DIR
          source venv/bin/activate

          pip install "$WHEEL_FILE" --force-reinstall --no-cache-dir > /tmp/pip_install.log 2>&1 && {
            echo "âœ… íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ"
            tail -20 /tmp/pip_install.log

            # ai_app ë””ë ‰í„°ë¦¬ì— ë°°í¬ ì½”ë“œ ë™ê¸°í™” (PM2ê°€ ì´ ê²½ë¡œì—ì„œ ì‹¤í–‰ë¨)
            if [ -d "$AI_APP_DIR" ]; then
              echo "ai_app ë””ë ‰í„°ë¦¬ì— ë°°í¬ ì½”ë“œ ë™ê¸°í™” ì¤‘..."
              AI_APP_SOURCE=$(python -c "import ai_app; import os; print(os.path.dirname(ai_app.__file__))" 2>/dev/null) || true
              if [ -n "$AI_APP_SOURCE" ] && [ -d "$AI_APP_SOURCE" ]; then
                rsync -a --delete "$AI_APP_SOURCE/" "$AI_APP_DIR/" 2>/dev/null || {
                  rm -rf "$AI_APP_DIR"/*
                  cp -r "$AI_APP_SOURCE"/* "$AI_APP_DIR/"
                }
                echo "âœ… ai_app ë™ê¸°í™” ì™„ë£Œ (site-packages â†’ $AI_APP_DIR)"
              else
                echo "âš ï¸ ai_app ëª¨ë“ˆ ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ì¡´ ì½”ë“œ ìœ ì§€"
              fi
            else
              mkdir -p "$AI_APP_DIR"
              AI_APP_SOURCE=$(python -c "import ai_app; import os; print(os.path.dirname(ai_app.__file__))" 2>/dev/null) || true
              if [ -n "$AI_APP_SOURCE" ] && [ -d "$AI_APP_SOURCE" ]; then
                cp -r "$AI_APP_SOURCE"/* "$AI_APP_DIR/"
                echo "âœ… ai_app ì´ˆê¸° ë³µì‚¬ ì™„ë£Œ"
              fi
            fi
          } || {
            echo "âŒ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹¤íŒ¨"
            tail -50 /tmp/pip_install.log

            # ë¡¤ë°±
            if [ -d "$BACKUP_DIR/code_$TIMESTAMP" ]; then
              rm -rf "$AI_APP_DIR"
              cp -r "$BACKUP_DIR/code_$TIMESTAMP" "$AI_APP_DIR"
              sudo chown -R ubuntu:ubuntu "$AI_APP_DIR" 2>/dev/null || true
            fi
            sudo lsof -ti:8000 | xargs -r sudo kill -9 2>/dev/null || true
            sudo -u ubuntu pm2 restart ${APP_NAME} 2>/dev/null || true
            rm -rf $TEMP_DIR
            exit 1
          }

          rm -rf $TEMP_DIR
          sudo chown -R ubuntu:ubuntu "$AI_APP_DIR" 2>/dev/null || true

          # PM2 í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
          echo "AI ê´€ë ¨ PM2 í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ ì¤‘..."
          sudo lsof -ti:8000 | xargs -r sudo kill -9 2>/dev/null || true
          sudo -u ubuntu pm2 list | grep -E 'ai-service|ai-serv' | awk '{print $2}' | while read -r process_name; do
            if [ -n "$process_name" ] && [ "$process_name" != "name" ]; then
              sudo -u ubuntu pm2 stop "$process_name" 2>/dev/null || true
              sudo -u ubuntu pm2 delete "$process_name" 2>/dev/null || true
            fi
          done
          sleep 1

          # PM2ë¡œ ì„œë¹„ìŠ¤ ì‹œì‘
          echo "AI ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..."
          sudo -u ubuntu pm2 start $PM2_CONFIG --only ${APP_NAME} --env production || exit 1

          sleep 3
          sudo -u ubuntu pm2 describe ${APP_NAME} > /dev/null || exit 1

          # ì„œë¹„ìŠ¤ ì´ˆê¸°í™” ëŒ€ê¸° (AI ëª¨ë¸ ë¡œë”© ê³ ë ¤)
          echo "ì„œë¹„ìŠ¤ ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘... (30ì´ˆ)"
          echo "AI ëª¨ë¸ ë¡œë”© ì¤‘... (ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)"
          sleep 30

          # Caddy ë¦¬ë¡œë“œ
          systemctl is-active --quiet caddy && sudo systemctl reload caddy 2>/dev/null || true
          sleep 2

          # í—¬ìŠ¤ì²´í¬ (ìµœëŒ€ 15íšŒ ì¬ì‹œë„, ê°„ê²© ì¦ê°€)
          echo "í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
          HEALTH_OK=false
          for i in {1..15}; do
            HTTP_STATUS=$(timeout 10 curl -s -o /dev/null -w "%{http_code}" "$HEALTH_CHECK_URL" 2>/dev/null || echo "000")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ! (HTTP $HTTP_STATUS) - ì‹œë„ $i/15"
              HEALTH_OK=true
              break
            fi
            echo "âš ï¸  ì‹œë„ $i/15: HTTP $HTTP_STATUS (AI ëª¨ë¸ ë¡œë”© ì¤‘ì¼ ìˆ˜ ìˆìŒ)"

            # ì ì§„ì  ëŒ€ê¸° ì‹œê°„ ì¦ê°€ (ì²˜ìŒì—” ì§§ê²Œ, ë‚˜ì¤‘ì—” ê¸¸ê²Œ)
            if [ $i -le 5 ]; then
              WAIT_TIME=5
            elif [ $i -le 10 ]; then
              WAIT_TIME=8
            else
              WAIT_TIME=10
            fi
            [ $i -lt 15 ] && sleep $WAIT_TIME
          done

          if [ "$HEALTH_OK" = "true" ]; then
            sudo -u ubuntu pm2 save 2>/dev/null || true

            # 7ì¼ ì´ìƒ ëœ ë°±ì—… ì •ë¦¬
            (find $BACKUP_DIR -name "code_*" -type d -mtime +7 -exec rm -rf {} + 2>/dev/null) &
            (find $BACKUP_DIR -name "wheel_*" -type d -mtime +7 -exec rm -rf {} + 2>/dev/null) &

            echo ""
            echo "============================================"
            echo "Re-Fit AI í”„ë¡œë•ì…˜ ë°°í¬ ì™„ë£Œ: $(date)"
            echo "============================================"
            exit 0
          fi

          # í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ - ë¡¤ë°±
          echo ""
          echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ - ë¡¤ë°± ì‹œì‘"
          echo "=== PM2 ë¡œê·¸ (ìµœê·¼ 30ì¤„) ==="
          sudo -u ubuntu pm2 logs ${APP_NAME} --lines 30 --nostream || true

          if [ -d "$BACKUP_DIR/code_$TIMESTAMP" ]; then
            rm -rf "$AI_APP_DIR"
            cp -r "$BACKUP_DIR/code_$TIMESTAMP" "$AI_APP_DIR"
            sudo chown -R ubuntu:ubuntu "$AI_APP_DIR" 2>/dev/null || true

            sudo lsof -ti:8000 | xargs -r sudo kill -9 2>/dev/null || true
            sudo -u ubuntu pm2 restart ${APP_NAME} 2>/dev/null || true
            sleep 5

            HTTP_STATUS=$(timeout 10 curl -s -o /dev/null -w "%{http_code}" "$HEALTH_CHECK_URL" 2>/dev/null || echo "000")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… ë¡¤ë°± ì„±ê³µ - ì´ì „ ë²„ì „ìœ¼ë¡œ ë³µêµ¬ë¨"
              sudo -u ubuntu pm2 save 2>/dev/null || true
            else
              echo "âš ï¸  ë¡¤ë°± í›„ì—ë„ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (HTTP $HTTP_STATUS)"
            fi
          fi
          exit 1
          SCRIPT_END
          )

          # SSM ëª…ë ¹ ì‹¤í–‰
          DEPLOY_SCRIPT_ENCODED=$(echo "$DEPLOY_SCRIPT" | base64 -w 0)
          SSM_COMMAND="bash -c \"echo '$DEPLOY_SCRIPT_ENCODED' | base64 -d | bash -s -- '$BASE_PATH' '$AI_DIR' '$AI_APP_DIR' '$BACKUP_DIR' '$TEMP_DIR' '$PM2_CONFIG' '$S3_BUCKET' '$S3_KEY' '$AI_HEALTH_URL'\""
          PARAMETERS_JSON=$(jq -n --arg cmd "$SSM_COMMAND" '{commands: [$cmd]}')

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$EC2_INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters "$PARAMETERS_JSON" \
            --timeout-seconds 1800 \
            --region ap-northeast-2 \
            --query 'Command.CommandId' \
            --output text)

          [ -n "$COMMAND_ID" ] || exit 1

          echo "SSM Command ID: $COMMAND_ID"

          # SSM ëª…ë ¹ ì‹¤í–‰ ìƒíƒœ í™•ì¸
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$EC2_INSTANCE_ID" \
              --region ap-northeast-2 \
              --query 'Status' \
              --output text 2>/dev/null || echo "InProgress")

            if [ "$STATUS" = "Success" ]; then
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$EC2_INSTANCE_ID" \
                --region ap-northeast-2 \
                --query 'StandardOutputContent' \
                --output text
              echo "success=true" >> $GITHUB_OUTPUT
              exit 0
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              echo "SSM Command failed with status: $STATUS"
              echo "=== Standard Output ==="
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$EC2_INSTANCE_ID" \
                --region ap-northeast-2 \
                --query 'StandardOutputContent' \
                --output text
              echo "=== Standard Error ==="
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$EC2_INSTANCE_ID" \
                --region ap-northeast-2 \
                --query 'StandardErrorContent' \
                --output text
              echo "success=false" >> $GITHUB_OUTPUT
              exit 1
            fi
            [ $i -eq 1 ] && echo "Waiting for SSM command to complete..."
            [ $i -eq 30 ] && echo "Still waiting... (30/60 checks)"
            sleep 5
          done

          echo "SSM Command timeout after 60 checks"
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1

  notify-result:
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    steps:
      - name: Notify Discord on Final Result
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          DEPLOY_RESULT: ${{ needs.deploy.result }}
          SHA: ${{ needs.deploy.outputs.deployment_sha }}
          RUN_ID: ${{ github.run_id }}
        run: |
          if [ "$DEPLOY_RESULT" = "success" ]; then
            EMOJI="âœ…"
            COLOR=3066993
            TITLE="AI í”„ë¡œë•ì…˜ ë°°í¬ ì„±ê³µ"
            MESSAGE="í”„ë¡œë•ì…˜ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            EMOJI="ğŸš¨"
            COLOR=15158332
            TITLE="AI í”„ë¡œë•ì…˜ ë°°í¬ ì‹¤íŒ¨"
            MESSAGE="í”„ë¡œë•ì…˜ ë°°í¬ ê³¼ì •ì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
          fi

          payload=$(cat <<EOF
          {
            "embeds": [{
              "title": "$EMOJI $TITLE",
              "color": $COLOR,
              "description": "$MESSAGE",
              "fields": [
                {"name": "ì„œë¹„ìŠ¤", "value": "Re-Fit AI (Prod)", "inline": true},
                {"name": "ë¸Œëœì¹˜", "value": "\`main\`", "inline": true},
                {"name": "ì»¤ë°‹", "value": "\`${SHA:0:7}\`", "inline": true},
                {"name": "ì›Œí¬í”Œë¡œìš°", "value": "[ìƒì„¸ ë³´ê¸°](https://github.com/${{ github.repository }}/actions/runs/$RUN_ID)", "inline": false}
              ],
              "footer": { "text": "Re-Fit AI Prod Deployment System" },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )
          curl -H "Content-Type: application/json" -X POST -d "$payload" "$DISCORD_WEBHOOK"
